<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON Formatter Tool</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css">
    <style>
        html, body {
            padding: 0;
            margin: 0;
            height: 100%;
            width: 100%;
            overflow: hidden;
            background-color: #f8f8f8;
            font-size: 14px; /* Base font size */
        }
        body {
            display: flex;
            flex-direction: column;
        }
        .container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
        }
        .ui.segment, .segment {
            border: 1px solid rgba(34,36,38,.15);
            border-radius: 0;
            box-shadow: none;
            background-color: white;
            padding: 1em;
            margin: 0;
        }
        .view-container {
            flex: 1;
            display: flex; /* Use flexbox for line numbers */
            overflow: hidden;
            position: relative; /* Needed for error message absolute positioning */
            background-color: white;
        }
        #line-numbers {
            font-family: monospace;
            padding: 10px 5px 10px 10px;
            background-color: #f7f7f7;
            color: #aaa;
            text-align: right;
            overflow: hidden;
            user-select: none;
            border-right: 1px solid #ddd;
            font-size: 0.9rem;
            line-height: 1.5; /* Match textarea line-height */
        }
        #json-input {
            font-family: monospace;
            resize: none;
            width: 100%;
            height: 100%;
            padding: 10px;
            box-sizing: border-box;
            flex: 1;
            overflow: auto;
            white-space: pre;
            border: none;
            border-radius: 0;
            outline: none;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        #json-tree {
            flex: 1;
            overflow: auto;
            padding: 10px;
            font-family: monospace;
            font-size: 0.9rem;
            line-height: 1.5;
            display: none; /* Hidden by default */
        }
        .error-message {
            color: #db2828;
            font-weight: bold;
            padding: 5px 10px;
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: rgba(255, 240, 240, 0.9);
            border-top: 1px solid #db2828;
            z-index: 10; 
        }
        .header-container {
            display: flex;
            align-items: center;
            padding: 5px 10px;
            background-color: #fff;
            border-bottom: 1px solid #ddd;
            flex-wrap: wrap; /* Allow wrapping */
        }
        .header {
            margin: 0;
            display: flex;
            align-items: center;
            font-size: 1.1rem;
            margin-right: 15px;
        }
        .view-switcher {
            margin-right: auto; /* Pushes buttons to the right */
        }
         .view-switcher .button {
            background-color: #eee;
            color: #555;
            padding: 0.4em 0.8em;
            font-size: 0.8rem;
            border-radius: 3px;
         }
         .view-switcher .button.active {
            background-color: #ddd;
            color: #333;
            font-weight: bold;
         }
        .buttons {
            display: flex;
            flex-wrap: nowrap; /* Prevent button wrapping within the group */
            gap: 5px;
            margin-left: 10px;
        }
        .button {
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-height: 1em;
            border: none;
            border-radius: 3px;
            padding: 0.4em 0.8em;
            font-weight: 700;
            transition: opacity 0.1s ease, background-color 0.1s ease, color 0.1s ease, box-shadow 0.1s ease;
            text-decoration: none;
            font-size: 0.8rem;
            white-space: nowrap; /* Prevent text wrapping inside button */
        }
        .primary.button {
            background-color: #2185d0;
            color: white;
        }
        .button:hover {
            background-color: #1678c2;
            color: white;
        }
        .view-switcher .button:hover {
            background-color: #ccc;
            color: #333;
        }
        .dropdown {
            position: relative;
            display: inline-block;
        }
        .dropdown .menu {
            position: absolute;
            top: 100%;
            right: 0; /* Align dropdown to the right */
            left: auto;
            z-index: 1000;
            display: none;
            min-width: 8rem;
            background-color: white;
            border: 1px solid rgba(34,36,38,.15);
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,.15);
        }
        .dropdown.active .menu {
            display: block;
        }
        .dropdown .item {
            padding: 0.4em 0.8em;
            cursor: pointer;
        }
        .dropdown .item:hover {
            background-color: rgba(0,0,0,.05);
        }
        .dropdown .text {
            margin-right: 5px;
        }
        .input-container {
            position: relative;
            flex: 1;
            display: flex; /* Changed to flex for main views */
            flex-direction: row; /* Default to row for text view + lines */
            overflow: hidden;
        }
        .hidden {
            display: none !important;
        }
        .status-bar {
            background-color: #f5f5f5;
            border-top: 1px solid #ddd;
            padding: 3px 10px;
            font-size: 0.8rem;
            color: #555;
            display: flex;
            justify-content: space-between;
        }
        .icon {
            display: inline-block;
            width: 1.18em;
            height: 1em;
            font-style: normal;
            text-decoration: inherit;
            text-align: center;
            speak: none;
        }
        /* Fallback icons using Unicode */
        .trash.icon:before { content: "🗑️"; }
        .copy.icon:before { content: "📋"; }
        .check.icon:before { content: "✓"; }
        .code.icon:before { content: "{ }"; }
        .dropdown.icon:before { content: "▼"; }

        /* Tree view styles */
        .json-tree {
            display: flex; /* 使用 flex 布局 */
        }
        
        .tree-line-numbers {
            min-width: 20px;
            text-align: right;
            padding-right: 8px;
            color: #aaa;
            user-select: none;
            border-right: 1px solid #ddd;
            margin-right: 8px;
        }
        
        .tree-content {
            flex: 1;
            overflow: auto;
        }
        
        .expand-icon {
            cursor: pointer;
            display: inline-block;
            width: 16px;
            text-align: center;
            user-select: none;
            margin-right: 3px;
        }
        
        .expand-icon::before {
            content: "▶";
            font-size: 0.8em;
            color: #888;
        }
        
        .expanded > .expand-icon::before {
            content: "▼";
            color: #333;
        }
        
        .json-item {
            white-space: nowrap;
            margin: 2px 0;
            cursor: default; /* 改为默认光标，因为只有三角形可点击 */
        }
        
        .json-children {
            display: none;
            padding-left: 20px;
        }
        
        .expanded > .json-children {
            display: block;
        }
        
        .collapsed-indicator {
            display: none;
            color: #888;
            padding: 0 3px;
            font-style: italic;
        }
        
        .json-item:not(.expanded) > .collapsed-indicator {
            display: inline-block;
        }
        
        /* 为不同类型的值添加颜色 */
        .key {
            color: #881391; /* 紫色 */
            font-weight: bold;
        }
        
        .value.string {
            color: #1a1aa6; /* 蓝色 */
        }
        
        .value.number {
            color: #098658; /* 绿色 */
        }
        
        .value.boolean, .value.null {
            color: #0000ff; /* 蓝色 */
            font-weight: bold;
        }
        
        .brace {
            color: #000000; /* 黑色 */
        }

        @media (max-width: 700px) { /* Adjusted breakpoint */
            .header-container {
                flex-direction: column;
                align-items: flex-start;
            }
            .view-switcher {
                margin-right: 0;
                margin-bottom: 5px;
            }
            .buttons {
                margin-left: 0;
                width: 100%;
                justify-content: space-between;
            }
            .button {
                padding: 0.3em 0.6em;
                font-size: 0.75rem;
            }
            .dropdown {
                 font-size: 0.75rem;
            }
            .dropdown .menu {
                min-width: 6rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-container">
            <h1 class="header">
                <span class="code icon"></span>
                <span style="margin-left: 5px;">JSON Formatter</span>
            </h1>

            <div class="view-switcher">
                <button class="button active" data-view="text">Text</button>
                <button class="button" data-view="tree">Tree</button>
            </div>
            
            <div class="buttons">
                <button class="primary button" id="format-btn">Format</button>
                <button class="button" id="minify-btn">Minify</button>
                <button class="button" id="validate-btn">Validate</button>
                <button class="button" id="copy-btn">Copy</button>
                <button class="button" id="clear-btn">Clear</button>
                
                <div class="dropdown" id="indent-dropdown">
                    <input type="hidden" name="indent" value="2">
                    <div class="text">2 Spaces</div>
                    <span class="dropdown icon"></span>
                    <div class="menu">
                        <div class="item" data-value="2">2 Spaces</div>
                        <div class="item" data-value="4">4 Spaces</div>
                        <div class="item" data-value="tab">Tab</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="view-container">
             <div id="line-numbers">1</div> <!-- Line numbers container -->
             <div class="input-container" id="text-view">
                 <textarea id="json-input" placeholder="Paste your JSON here..."></textarea>
             </div>
             <div id="json-tree" class="json-tree"></div> <!-- Tree view container -->
             <div class="error-message hidden" id="error-message"></div>
        </div>
        
        <div class="status-bar">
            <div id="status-message"></div>
            <div id="char-count">Characters: 0</div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.js"></script>
    <script>
        // Fallback for jQuery if CDN fails
        if (typeof jQuery === 'undefined') {
            // Simple DOM manipulation functions
            function $(selector) {
                if (typeof selector === 'string') {
                    const elements = document.querySelectorAll(selector);
                    return {
                        elements: elements,
                        val: function(value) {
                            if (value === undefined) {
                                return this.elements[0] ? this.elements[0].value : '';
                            } else {
                                this.elements.forEach(el => el.value = value);
                                return this;
                            }
                        },
                        text: function(value) {
                            if (value === undefined) {
                                return this.elements[0] ? this.elements[0].textContent : '';
                            } else {
                                this.elements.forEach(el => el.textContent = value);
                                return this;
                            }
                        },
                        html: function(value) {
                             if (value === undefined) {
                                 return this.elements[0] ? this.elements[0].innerHTML : '';
                             } else {
                                 this.elements.forEach(el => el.innerHTML = value);
                                 return this;
                             }
                         },
                        addClass: function(className) {
                            this.elements.forEach(el => el.classList.add(className));
                            return this;
                        },
                        removeClass: function(className) {
                            this.elements.forEach(el => el.classList.remove(className));
                            return this;
                        },
                         css: function(prop, value) {
                             if (value === undefined) {
                                 // Simple getter for single property
                                 return this.elements[0] ? window.getComputedStyle(this.elements[0])[prop] : undefined;
                             } else {
                                 this.elements.forEach(el => el.style[prop] = value);
                                 return this;
                             }
                         },
                        find: function(childSelector) {
                            const children = [];
                            this.elements.forEach(el => {
                                const found = el.querySelectorAll(childSelector);
                                found.forEach(child => children.push(child));
                            });
                             // Return a new chainable object
                             const newQuery = { elements: children };
                             Object.assign(newQuery, this);
                             newQuery.elements = children; // Ensure elements are the found children
                             return newQuery;
                        },
                        on: function(event, callback) {
                            this.elements.forEach(el => el.addEventListener(event, callback));
                            return this;
                        },
                        // Basic implementation for scroll event
                         scrollTop: function(value) {
                             if (value === undefined) {
                                 return this.elements[0] ? this.elements[0].scrollTop : 0;
                             } else {
                                 this.elements.forEach(el => el.scrollTop = value);
                                 return this;
                             }
                         }
                    };
                } else if (typeof selector === 'function') {
                     // Handle document ready
                     documentReady(selector);
                     return undefined; // Return undefined for ready function
                 } else if (selector.nodeType || selector === window || selector === document) {
                     // Handle direct nodes, window, document
                     const newQuery = { elements: [selector] };
                     // Copy methods from prototype, but be careful not to overwrite 'elements'
                     Object.assign(newQuery, $().constructor.prototype);
                     newQuery.elements = [selector];
                     return newQuery;
                 } else {
                    return { elements: [] }; // Return empty set for invalid selectors
                 }
            }

            $.fn = {}; // Keep for potential Semantic UI fallback check
            
            // Simple document ready function
            function documentReady(fn) {
                if (document.readyState !== 'loading') {
                    fn();
                } else {
                    document.addEventListener('DOMContentLoaded', fn);
                }
            }
        } 

        // Initialize dropdown functionality (Semantic UI or fallback)
        function initDropdown() {
            const dropdown = document.getElementById('indent-dropdown');
            if (!dropdown) return;

            const textEl = dropdown.querySelector('.text');
            const inputEl = dropdown.querySelector('input');
            const menuEl = dropdown.querySelector('.menu');

            dropdown.addEventListener('click', function(e) {
                this.classList.toggle('active');
                e.stopPropagation();
            });

            menuEl.addEventListener('click', function(e) {
                if (e.target.classList.contains('item')) {
                    const value = e.target.getAttribute('data-value');
                    inputEl.value = value;
                    textEl.textContent = e.target.textContent;
                    dropdown.classList.remove('active');
                }
            });

            document.addEventListener('click', function() {
                dropdown.classList.remove('active');
            });
        }

        // Function to create Tree View HTML
        function createTreeView(jsonObj) {
            const lineNumbersDiv = document.createElement('div');
            lineNumbersDiv.className = 'tree-line-numbers';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'tree-content';
            
            // 递归构建 JSON 结构
            function buildJsonItem(obj, key = null, lineNum = 1) {
                const isArray = Array.isArray(obj);
                const isObject = obj !== null && typeof obj === 'object';
                const itemDiv = document.createElement('div');
                itemDiv.className = 'json-item';
                
                // 为对象和数组添加可点击属性
                if (isObject) {
                    itemDiv.setAttribute('data-expandable', 'true');
                }
                
                // 生成行号
                lineNumbersDiv.innerHTML += lineNum + '<br>';
                
                // 生成当前行内容
                let content = '';
                
                // 添加键名和冒号（如果有的话）
                if (key !== null) {
                    if (typeof key === 'number') {
                        content += `<span class="key array-index">${key}:</span> `;
                    } else {
                        content += `<span class="key">"${key}":</span> `;
                    }
                }
                
                // 为对象和数组添加展开/折叠图标
                if (isObject) {
                    const expandIcon = document.createElement('span');
                    expandIcon.className = 'expand-icon';
                    expandIcon.onclick = function(e) {
                        e.stopPropagation(); // 防止事件冒泡
                        const parentItem = this.parentNode;
                        parentItem.classList.toggle('expanded');
                    };
                    itemDiv.appendChild(expandIcon);
                    
                    // 添加左括号（与文本视图格式一致）
                    content += `<span class="brace">${isArray ? '[' : '{'}</span>`;
                    
                    // 计算子项数量
                    const childCount = isArray ? obj.length : Object.keys(obj).length;
                    const itemText = childCount === 1 ? 'item' : 'items';
                    
                    // 添加折叠时显示的子项数量提示
                    content += `<span class="collapsed-indicator">${childCount} ${itemText}</span>`;
                    
                    itemDiv.innerHTML += content;
                    
                    // 创建子项的容器
                    const childrenDiv = document.createElement('div');
                    childrenDiv.className = 'json-children';
                    
                    // 处理空对象/数组
                    if (isArray && obj.length === 0) {
                        lineNumbersDiv.innerHTML += (lineNum + 1) + '<br>';
                        childrenDiv.innerHTML = '<div class="json-item"><em>/* empty array */</em></div>';
                        lineNum++;
                    } else if (!isArray && Object.keys(obj).length === 0) {
                        lineNumbersDiv.innerHTML += (lineNum + 1) + '<br>';
                        childrenDiv.innerHTML = '<div class="json-item"><em>/* empty object */</em></div>';
                        lineNum++;
                    } else {
                        // 递归处理子项
                        let childKeys = isArray ? [...Array(obj.length).keys()] : Object.keys(obj);
                        lineNum++;
                        
                        childKeys.forEach((childKey) => {
                            const childValue = obj[childKey];
                            const [childContent, newLineNum] = buildJsonItem(childValue, childKey, lineNum);
                            childrenDiv.appendChild(childContent);
                            lineNum = newLineNum;
                        });
                    }
                    
                    // 添加右括号
                    lineNumbersDiv.innerHTML += lineNum + '<br>';
                    childrenDiv.innerHTML += `<div class="json-item"><span class="brace">${isArray ? ']' : '}'}</span></div>`;
                    
                    // 为外部容器添加右括号（在折叠时显示）
                    const closeBrace = document.createElement('span');
                    closeBrace.className = 'brace';
                    closeBrace.textContent = isArray ? ']' : '}';
                    itemDiv.appendChild(childrenDiv);
                    itemDiv.appendChild(closeBrace);
                    
                    itemDiv.classList.add('expanded'); // 默认展开
                    lineNum++;
                    
                    return [itemDiv, lineNum];
                } else {
                    // 基本类型值的处理
                    const valueType = (obj === null) ? 'null' : typeof obj;
                    let displayValue = JSON.stringify(obj);
                    
                    // 为字符串添加颜色
                    if (valueType === 'string') {
                        content += `<span class="value string">${displayValue}</span>`;
                    } else if (valueType === 'number') {
                        content += `<span class="value number">${displayValue}</span>`;
                    } else if (valueType === 'boolean') {
                        content += `<span class="value boolean">${displayValue}</span>`;
                    } else if (valueType === 'null') {
                        content += `<span class="value null">${displayValue}</span>`;
                    } else {
                        content += `<span class="value">${displayValue}</span>`;
                    }
                    
                    itemDiv.innerHTML += content;
                    
                    return [itemDiv, lineNum + 1];
                }
            }
            
            const [rootItem] = buildJsonItem(jsonObj);
            contentDiv.appendChild(rootItem);
            
            // 创建包含行号和内容的完整树视图
            const treeView = document.createElement('div');
            treeView.className = 'tree-view';
            treeView.style.display = 'flex';
            treeView.appendChild(lineNumbersDiv);
            treeView.appendChild(contentDiv);
            
            return treeView.outerHTML;
        }

        // Function to update line numbers
        function updateLineNumbers() {
            const linesDiv = document.getElementById('line-numbers');
            const textarea = document.getElementById('json-input');
            if (!linesDiv || !textarea) return;

            try {
                const lines = textarea.value.split('\n');
                const lineCount = lines.length;
                let linesHtml = '';
                for (let i = 1; i <= lineCount; i++) {
                    linesHtml += i + '<br>';
                }
                linesDiv.innerHTML = linesHtml;

                // Synchronize scroll
                linesDiv.scrollTop = textarea.scrollTop;
            } catch (e) {
                console.error("Error updating line numbers:", e);
                linesDiv.innerHTML = '1'; // Fallback
            }
        }
        
        // Document ready function
        (function() {
            // Try to use jQuery if available, otherwise use our fallback
            const ready = (typeof jQuery !== 'undefined') ? jQuery : documentReady;
            
            ready(function() {
                // Initialize dropdowns if Semantic UI is not available
                if (typeof $.fn.dropdown === 'undefined') {
                    initDropdown();
                } else {
                    $('.dropdown').dropdown(); // Use basic selector
                }
                
                // DOM Elements
                const jsonInput = $('#json-input');
                const lineNumbers = $('#line-numbers');
                const treeViewContainer = $('#json-tree');
                const textViewContainer = $('#text-view');
                const formatBtn = $('#format-btn');
                const minifyBtn = $('#minify-btn');
                const validateBtn = $('#validate-btn');
                const errorMessage = $('#error-message');
                const indentDropdown = $('#indent-dropdown');
                const copyBtn = $('#copy-btn');
                const clearBtn = $('#clear-btn');
                const statusMessage = $('#status-message');
                const charCount = $('#char-count');
                const viewSwitcherBtns = $(".view-switcher .button");
                
                let currentView = 'text'; // Default view
                let currentJson = null; // Store parsed JSON

                // Sample JSON for initial demo
                const sampleJson = {
                    "name": "JSON Formatter Tool",
                    "description": "A tool to format, validate and beautify JSON data",
                    "features": ["Format", "Minify", "Validate"],
                    "settings": {
                        "indentation": 2,
                        "theme": "light"
                    },
                    "isAwesome": true,
                    "version": 1.0,
                    "nested": {
                        "level1": [1, 2, {"deep": true}]
                    }
                };
                
                // Set sample JSON
                jsonInput.val(JSON.stringify(sampleJson, null, 2));
                try { currentJson = JSON.parse(jsonInput.val()); } catch(e) { currentJson = null; }
                updateCharCount();
                updateLineNumbers();
                renderTreeView(); // Initial render
                
                // Update character count
                function updateCharCount() {
                    const count = jsonInput.val().length;
                    charCount.text(`Characters: ${count.toLocaleString()}`);
                }

                // Render Tree View
                function renderTreeView() {
                    if (currentJson && currentView === 'tree') {
                        const startTime = performance.now();
                        try {
                            const treeHtml = createTreeView(currentJson);
                            treeViewContainer.html(treeHtml);
                            
                            // 删除在json-item上的点击事件，只保留expand-icon上的点击事件
                            if (typeof $ !== 'undefined') {
                                // 确保只有三角形图标可以触发展开/折叠
                                $('#json-tree').off('click');
                                // 为expand-icon重新绑定事件，确保它正常工作
                                $('#json-tree').on('click', '.expand-icon', function(e) {
                                    const parentItem = this.parentNode;
                                    parentItem.classList.toggle('expanded');
                                    e.stopPropagation();
                                });
                            } else {
                                // 原生 JavaScript 回退
                                const container = document.getElementById('json-tree');
                                container.removeEventListener('click', container.clickHandler);
                                
                                // 添加专门针对expand-icon的点击处理
                                container.clickHandler = function(e) {
                                    if (e.target.classList.contains('expand-icon')) {
                                        const parentItem = e.target.parentNode;
                                        parentItem.classList.toggle('expanded');
                                        e.stopPropagation();
                                    }
                                };
                                container.addEventListener('click', container.clickHandler);
                            }

                            const endTime = performance.now();
                            statusMessage.text(`Tree rendered in ${(endTime - startTime).toFixed(2)}ms`);
                        } catch (e) {
                            console.error("Error rendering tree:", e);
                            treeViewContainer.html('<p style="color: red;">Error rendering tree view.</p>');
                            statusMessage.text(`Error rendering tree.`);
                        }
                    } else {
                        treeViewContainer.html(''); // Clear if no valid JSON or not in tree view
                    }
                }
                
                // Input change event
                jsonInput.on('input', function() {
                    errorMessage.addClass('hidden'); // Hide error on new input
                    statusMessage.text('');
                    try { currentJson = JSON.parse(jsonInput.val()); } catch(e) { currentJson = null; }
                    updateCharCount();
                    updateLineNumbers();
                     // Optionally update tree view live? Might be slow. Let's update on format.
                });

                // Sync scroll for line numbers
                 jsonInput.on('scroll', function() {
                     lineNumbers.scrollTop(jsonInput.scrollTop());
                 });
                
                // Format JSON
                formatBtn.on('click', function() {
                    formatJson();
                });
                
                // Minify JSON
                minifyBtn.on('click', function() {
                    minifyJson();
                });
                
                // Validate JSON
                validateBtn.on('click', function() {
                    validateJson();
                });
                
                // Clear input
                clearBtn.on('click', function() {
                    jsonInput.val('');
                    errorMessage.addClass('hidden');
                    statusMessage.text('');
                    currentJson = null;
                    updateCharCount();
                    updateLineNumbers();
                    renderTreeView();
                });
                
                // Copy output
                copyBtn.on('click', function() {
                    // Copy raw text regardless of view
                    const output = jsonInput.val();
                    copyToClipboard(output);
                    
                    statusMessage.text('Copied to clipboard!');
                    setTimeout(() => {
                        statusMessage.text('');
                    }, 2000);
                });

                // View Switcher Logic
                 viewSwitcherBtns.on('click', function(e) {
                     const targetView = e.target.getAttribute('data-view');
                     if (targetView === currentView) return;

                     currentView = targetView;

                     // Update button styles
                     viewSwitcherBtns.removeClass('active');
                     $(e.target).addClass('active');

                     // Toggle view visibility
                     if (currentView === 'text') {
                         textViewContainer.css('display', 'flex'); // Use flex for line numbers
                         treeViewContainer.css('display', 'none');
                         lineNumbers.css('display', 'block'); // Show line numbers in text mode
                         updateLineNumbers(); // Ensure line numbers are up-to-date
                     } else { // Tree view
                         textViewContainer.css('display', 'none');
                         treeViewContainer.css('display', 'block');
                         lineNumbers.css('display', 'none'); // Hide main line numbers in tree mode
                         renderTreeView(); // Render tree if switching to it
                     }
                      errorMessage.addClass('hidden'); // Hide error on view switch
                      statusMessage.text('');
                 });
                
                // Format JSON function
                function formatJson() {
                    try {
                        const startTime = performance.now();
                        currentJson = JSON.parse(jsonInput.val()); // Update currentJson
                        const indent = getIndentation();
                        const formatted = JSON.stringify(currentJson, null, indent);
                        jsonInput.val(formatted);
                        errorMessage.addClass('hidden');
                        
                        const endTime = performance.now();
                        statusMessage.text(`Formatted in ${(endTime - startTime).toFixed(2)}ms`);
                        updateCharCount();
                        updateLineNumbers();
                        renderTreeView(); // Update tree view as well
                    } catch (e) {
                        showError(e.message);
                        currentJson = null; // Invalidate JSON on error
                        renderTreeView(); // Clear tree on error
                    }
                }
                
                // Minify JSON function
                function minifyJson() {
                    try {
                        const startTime = performance.now();
                        currentJson = JSON.parse(jsonInput.val()); // Update currentJson
                        const minified = JSON.stringify(currentJson);
                        jsonInput.val(minified);
                        errorMessage.addClass('hidden');
                        
                        // Switch to text view if not already there, as tree view isn't useful for minified
                        if (currentView !== 'text') {
                             viewSwitcherBtns.elements.forEach(btn => {
                                 if (btn.getAttribute('data-view') === 'text') {
                                     btn.click(); // Simulate click
                                 }
                             });
                         }

                        const endTime = performance.now();
                        statusMessage.text(`Minified in ${(endTime - startTime).toFixed(2)}ms`);
                        updateCharCount();
                        updateLineNumbers();
                        renderTreeView(); // Clear tree view content
                    } catch (e) {
                        showError(e.message);
                        currentJson = null; // Invalidate JSON on error
                        renderTreeView(); // Clear tree on error
                    }
                }
                
                // Validate JSON function
                function validateJson() {
                    try {
                        const startTime = performance.now();
                        currentJson = JSON.parse(jsonInput.val()); // Update currentJson
                        errorMessage.addClass('hidden');
                        
                        const endTime = performance.now();
                        statusMessage.text(`Valid JSON! Validated in ${(endTime - startTime).toFixed(2)}ms`);
                        // Re-render tree if in tree view to ensure it reflects validated JSON
                        if (currentView === 'tree') {
                           renderTreeView(); 
                        }
                    } catch (e) {
                        showError(e.message);
                        currentJson = null; // Invalidate JSON on error
                         renderTreeView(); // Clear tree on error
                    }
                }
                
                // Get indentation setting
                function getIndentation() {
                    let value;
                    // Check if Semantic UI dropdown is initialized
                    const dropdownElement = document.getElementById('indent-dropdown');
                    if (typeof $ !== 'undefined' && typeof $.fn.dropdown !== 'undefined' && dropdownElement && dropdownElement.classList.contains('ui')) {
                        value = $(indentDropdown).dropdown('get value');
                    } else {
                        // Fallback
                        const input = document.querySelector('#indent-dropdown input');
                        value = input ? input.value : '2';
                    }
                    
                    if (value === 'tab') {
                        return '\t';
                    }
                    return parseInt(value) || 2;
                }
                
                // Show error message
                function showError(message) {
                    errorMessage.text('Error: ' + message);
                    errorMessage.removeClass('hidden');
                    statusMessage.text('');
                }
                
                // Copy to clipboard function
                function copyToClipboard(text) {
                    if (!navigator.clipboard) {
                        // Fallback for older browsers
                        const textarea = document.createElement('textarea');
                        textarea.value = text;
                        textarea.style.position = 'fixed'; // Prevent scrolling to bottom
                        document.body.appendChild(textarea);
                        textarea.focus();
                        textarea.select();
                        try {
                            document.execCommand('copy');
                        } catch (err) {
                            console.error('Fallback: Oops, unable to copy', err);
                        }
                        document.body.removeChild(textarea);
                        return;
                    }
                    navigator.clipboard.writeText(text).then(function() {
                        /* success */
                    }, function(err) {
                        console.error('Async: Could not copy text: ', err);
                    });
                }
                
                // Format on load
                formatJson();
            });
        })();
    </script>
</body>
</html> 