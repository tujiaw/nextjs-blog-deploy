<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON Formatter Tool</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css">
    <style>
        html, body {
            padding: 0;
            margin: 0;
            height: 100%;
            width: 100%;
            overflow: hidden;
            background-color: #f8f8f8;
            font-size: 14px; /* Base font size */
        }
        body {
            display: flex;
            flex-direction: column;
        }
        .container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
        }
        .ui.segment, .segment {
            border: 1px solid rgba(34,36,38,.15);
            border-radius: 0;
            box-shadow: none;
            background-color: white;
            padding: 1em;
            margin: 0;
        }
        .view-container {
            flex: 1;
            display: flex; /* Using flexbox for side-by-side layout */
            overflow: hidden;
            position: relative; /* Needed for error message absolute positioning */
            background-color: white;
        }
        #line-numbers {
            font-family: monospace;
            padding: 10px 5px 10px 10px;
            background-color: #f7f7f7;
            color: #aaa;
            text-align: right;
            overflow: hidden;
            user-select: none;
            border-right: 1px solid #ddd;
            font-size: 0.9rem;
            line-height: 1.5; /* Match textarea line-height */
            width: 40px; /* å›ºå®šå®½åº¦ */
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            z-index: 3;
        }
        #json-input {
            font-family: monospace;
            resize: none;
            width: calc(100% - 40px); /* å‡å»è¡Œå·å®½åº¦ */
            height: 100%;
            padding: 10px;
            box-sizing: border-box;
            flex: 1;
            overflow: auto;
            white-space: pre-wrap; /* Change from pre to pre-wrap to enable word wrapping */
            word-wrap: break-word; /* Add break-word to ensure long words are broken */
            border: none;
            border-radius: 0;
            outline: none;
            font-size: 0.9rem;
            line-height: 1.5;
            position: absolute;
            top: 0;
            left: 0;
            color: rgba(0,0,0,0.8);
            background: white;
            z-index: 2;
        }
        #highlighted-json {
            display: none; /* éšè—é«˜äº®å…ƒç´ ï¼Œæ”¹ä¸ºç›´æ¥ç¼–è¾‘ */
            font-family: monospace;
            width: 100%;
            height: 100%;
            padding: 10px;
            box-sizing: border-box;
            flex: 1;
            overflow: auto;
            white-space: pre;
            border: none;
            border-radius: 0;
            outline: none;
            font-size: 0.9rem;
            line-height: 1.5;
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: 1;
        }
        .input-container {
            position: relative;
            flex: 1;
            display: flex;
            flex-direction: row; /* Default to row for text view + lines */
            overflow: hidden;
        }
        .tree-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        #json-tree {
            flex: 1;
            overflow: auto;
            padding: 10px;
            font-family: monospace;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        .error-message {
            color: #db2828;
            font-weight: bold;
            padding: 5px 10px;
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: rgba(255, 240, 240, 0.9);
            border-top: 1px solid #db2828;
            z-index: 10; 
        }
        .header-container {
            display: flex;
            align-items: center;
            padding: 10px;
            background-color: #fff;
            border-bottom: 1px solid #ddd;
            flex-wrap: wrap; /* Allow wrapping */
            gap: 10px; /* Add gap between elements */
        }
        .header {
            margin: 0;
            display: flex;
            align-items: center;
            font-size: 1.1rem;
            margin-right: 15px;
            white-space: nowrap;
        }
        .view-switcher {
            margin-right: 15px; /* Change from auto to fixed margin */
        }
        .buttons {
            display: flex;
            flex-wrap: nowrap; /* Prevent button wrapping within the group */
            gap: 5px;
        }
        /* Make buttons more compact */
        .ui.tiny.button {
            padding: 0.5em 0.7em !important;
            font-size: 0.85rem !important;
            height: 28px !important;
        }
        /* Make button group buttons match height */
        .ui.buttons .ui.button {
            padding: 0.5em 0.7em !important;
            font-size: 0.85rem !important;
            height: 28px !important;
        }
        /* Reduce dropdown width */
        .ui.tiny.selection.dropdown {
            min-width: 90px !important;
            padding: 0.5em 0.7em !important;
            font-size: 0.85rem !important;
            height: 28px !important;
            line-height: 1 !important;
            display: flex !important;
            align-items: center !important;
        }
        /* Fix dropdown icon alignment */
        .ui.dropdown .dropdown.icon {
            line-height: 1 !important;
            margin: 0 0 0 0.5em !important;
            height: auto !important;
            position: absolute !important;
            right: 0.4em !important;
            top: 50% !important;
            transform: translateY(-50%) !important;
        }
        /* Fix the text alignment in dropdown */
        .ui.selection.dropdown .text {
            margin-right: 1em !important;
            line-height: 1 !important;
        }
        .dropdown {
            position: relative;
            display: inline-block;
        }
        .dropdown .menu {
            position: absolute;
            top: 100%;
            right: 0; /* Align dropdown to the right */
            left: auto;
            z-index: 1000;
            display: none;
            min-width: 6rem;
            background-color: white;
            border: 1px solid rgba(34,36,38,.15);
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,.15);
        }
        .dropdown.active .menu {
            display: block;
        }
        .dropdown .item {
            padding: 0.2em 0.4em;
            cursor: pointer;
        }
        .dropdown .item:hover {
            background-color: rgba(0,0,0,.05);
        }
        .dropdown .text {
            margin-right: 2px;
        }
        .hidden {
            display: none !important;
        }
        .status-bar {
            background-color: #f5f5f5;
            border-top: 1px solid #ddd;
            padding: 3px 10px;
            font-size: 0.8rem;
            color: #555;
            display: flex;
            justify-content: space-between;
        }
        .icon {
            display: inline-block;
            width: 1.18em;
            height: 1em;
            font-style: normal;
            text-decoration: inherit;
            text-align: center;
            speak: none;
        }
        /* Fallback icons using Unicode */
        .trash.icon:before { content: "ğŸ—‘ï¸"; }
        .copy.icon:before { content: "ğŸ“‹"; }
        .check.icon:before { content: "âœ“"; }
        .code.icon:before { content: "{ }"; }
        .dropdown.icon:before { content: "â–¼"; }

        /* Tree view styles */
        .json-tree {
            display: flex; /* ä½¿ç”¨ flex å¸ƒå±€ */
        }
        
        .tree-content {
            flex: 1;
            overflow: auto;
            padding-left: 5px; /* æ·»åŠ å·¦ä¾§å¡«å……ä½¿å†…å®¹ä¸è´´è¾¹ */
        }
        
        .expand-icon {
            cursor: pointer;
            display: inline-block;
            width: 16px;
            text-align: center;
            user-select: none;
            margin-right: 3px;
        }
        
        .expand-icon::before {
            content: "â–¶";
            font-size: 0.8em;
            color: #888;
        }
        
        .expanded > .expand-icon::before {
            content: "â–¼";
            color: #333;
        }
        
        .json-item {
            white-space: nowrap;
            margin: 2px 0;
            cursor: default; /* æ”¹ä¸ºé»˜è®¤å…‰æ ‡ï¼Œå› ä¸ºåªæœ‰ä¸‰è§’å½¢å¯ç‚¹å‡» */
        }
        
        .json-children {
            display: none;
            padding-left: 20px;
        }
        
        .expanded > .json-children {
            display: block;
        }
        
        .collapsed-indicator {
            display: none;
            color: #888;
            padding: 0 3px;
            font-style: italic;
        }
        
        .json-item:not(.expanded) > .collapsed-indicator {
            display: inline-block;
        }
        
        /* ä¸ºä¸åŒç±»å‹çš„å€¼æ·»åŠ é¢œè‰² - ç”¨äºä¸¤ç§è§†å›¾ */
        .key {
            color: #0033B3; /* äº®è“è‰² */
            font-weight: bold;
        }
        
        .value.string {
            color: #008000; /* äº®ç»¿è‰² */
        }
        
        .value.number {
            color: #E67700; /* äº®æ©™è‰² */
        }
        
        .value.boolean, .value.null {
            color: #D53C4E; /* äº®çº¢è‰² */
            font-weight: bold;
        }
        
        .brace, .bracket, .comma, .colon {
            color: #555555; /* æ·±ç°è‰² */
        }

        @media (max-width: 700px) { /* Adjusted breakpoint */
            .header-container {
                flex-direction: column;
                align-items: flex-start;
                padding: 8px;
            }
            .view-switcher {
                display: none; /* Hide view switcher on mobile */
            }
            .view-container {
                flex-direction: column; /* Stack views on mobile */
            }
            #line-numbers {
                width: 40px;
                position: absolute;
                right: 0;
                top: 0;
                bottom: 0;
                overflow-y: auto;
                padding: 10px 5px;
            }
            #json-input {
                width: calc(100% - 40px);
            }
            .resizer {
                width: 100%;
                height: 6px;
                cursor: row-resize;
            }
            .buttons {
                margin-left: 0;
                width: 100%;
                justify-content: space-between;
                flex-wrap: wrap;
                gap: 5px;
            }
            .header {
                margin-bottom: 5px;
                font-size: 1rem;
            }
        }

        .disabled {
            opacity: 0.45 !important;
            cursor: default !important;
            pointer-events: none !important;
        }

        .collapsed-brace {
            display: none; /* é»˜è®¤éšè— */
        }
        
        .json-item:not(.expanded) > .collapsed-brace {
            display: inline-block; /* æŠ˜å çŠ¶æ€æ—¶æ˜¾ç¤º */
        }

        /* æ·»åŠ åˆ†éš”æ¡æ ·å¼ */
        .resizer {
            width: 6px;
            cursor: col-resize;
            background-color: #f0f0f0;
            border-left: 1px solid #ddd;
            border-right: 1px solid #ddd;
            z-index: 10;
        }
        .resizer:hover {
            background-color: #ddd;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-container">
            <h1 class="header">
                <span style="margin-left: 5px;">JSON Formatter</span>
            </h1>

            <div class="buttons">
                <button class="ui tiny primary button" id="format-btn">Format</button>
                <button class="ui tiny button" id="minify-btn">Minify</button>
                <button class="ui tiny button" id="validate-btn">Validate</button>
                <button class="ui tiny button" id="copy-btn">Copy</button>
                <button class="ui tiny button" id="clear-btn">Clear</button>
                
                <div class="ui tiny selection dropdown" id="indent-dropdown">
                    <input type="hidden" name="indent" value="2">
                    <i class="dropdown icon"></i>
                    <div class="default text">2 Spaces</div>
                    <div class="menu">
                        <div class="item" data-value="2">2 Spaces</div>
                        <div class="item" data-value="4">4 Spaces</div>
                        <div class="item" data-value="tab">Tab</div>
                    </div>
                </div>
                
                <div class="ui tiny checkbox" id="fix-json-checkbox" style="margin-left: 10px; display: flex; align-items: center;">
                    <input type="checkbox" checked>
                    <label style="font-size: 0.85rem; cursor: pointer;">Fix JSON</label>
                </div>
            </div>
            
            <div class="view-switcher">
                <div class="ui tiny basic buttons">
                    <button class="ui button active" data-view="text">Text</button>
                    <button class="ui button" data-view="tree">Tree</button>
                </div>
            </div>
        </div>

        <div class="view-container">
             <div class="input-container" id="text-view">
                 <textarea id="json-input" placeholder="Paste your JSON here..."></textarea>
                 <div id="line-numbers">1</div>
             </div>
             <div class="resizer" id="resizer"></div> <!-- ä¿ç•™å•ä¸ªåˆ†éš”æ¡ -->
             <div class="tree-container">
                 <div id="json-tree" class="json-tree"></div> <!-- Tree view container -->
             </div>
             <div class="error-message hidden" id="error-message"></div>
        </div>
        
        <div class="status-bar">
            <div id="status-message"></div>
            <div id="char-count">Characters: 0</div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.js"></script>
    <script>
        // Fallback for jQuery if CDN fails
        if (typeof jQuery === 'undefined') {
            // Simple DOM manipulation functions
            function $(selector) {
                if (typeof selector === 'string') {
                    const elements = document.querySelectorAll(selector);
                    return {
                        elements: elements,
                        val: function(value) {
                            if (value === undefined) {
                                return this.elements[0] ? this.elements[0].value : '';
                            } else {
                                this.elements.forEach(el => el.value = value);
                                return this;
                            }
                        },
                        text: function(value) {
                            if (value === undefined) {
                                return this.elements[0] ? this.elements[0].textContent : '';
                            } else {
                                this.elements.forEach(el => el.textContent = value);
                                return this;
                            }
                        },
                        html: function(value) {
                             if (value === undefined) {
                                 return this.elements[0] ? this.elements[0].innerHTML : '';
                             } else {
                                 this.elements.forEach(el => el.innerHTML = value);
                                 return this;
                             }
                         },
                        addClass: function(className) {
                            this.elements.forEach(el => el.classList.add(className));
                            return this;
                        },
                        removeClass: function(className) {
                            this.elements.forEach(el => el.classList.remove(className));
                            return this;
                        },
                         css: function(prop, value) {
                             if (value === undefined) {
                                 // Simple getter for single property
                                 return this.elements[0] ? window.getComputedStyle(this.elements[0])[prop] : undefined;
                             } else {
                                 this.elements.forEach(el => el.style[prop] = value);
                                 return this;
                             }
                         },
                        find: function(childSelector) {
                            const children = [];
                            this.elements.forEach(el => {
                                const found = el.querySelectorAll(childSelector);
                                found.forEach(child => children.push(child));
                            });
                             // Return a new chainable object
                             const newQuery = { elements: children };
                             Object.assign(newQuery, this);
                             newQuery.elements = children; // Ensure elements are the found children
                             return newQuery;
                        },
                        on: function(event, callback) {
                            this.elements.forEach(el => el.addEventListener(event, callback));
                            return this;
                        },
                        // Basic implementation for scroll event
                         scrollTop: function(value) {
                             if (value === undefined) {
                                 return this.elements[0] ? this.elements[0].scrollTop : 0;
                             } else {
                                 this.elements.forEach(el => el.scrollTop = value);
                                 return this;
                             }
                         },
                         // Add delay and queue support for animations
                         delay: function(ms) {
                             this.delayTime = ms;
                             return this;
                         },
                         queue: function(callback) {
                             if (this.delayTime) {
                                 const self = this;
                                 setTimeout(function() {
                                     callback.call(self.elements[0]);
                                 }, this.delayTime);
                                 this.delayTime = 0;
                             } else {
                                 callback.call(this.elements[0]);
                             }
                             return this;
                         },
                         hide: function() {
                             this.elements.forEach(el => {
                                 el.style.display = 'none';
                             });
                             return this;
                         }
                    };
                } else if (typeof selector === 'function') {
                     // Handle document ready
                     documentReady(selector);
                     return undefined; // Return undefined for ready function
                 } else if (selector.nodeType || selector === window || selector === document) {
                     // Handle direct nodes, window, document
                     const newQuery = { elements: [selector] };
                     // Copy methods from prototype, but be careful not to overwrite 'elements'
                     Object.assign(newQuery, $().constructor.prototype);
                     newQuery.elements = [selector];
                     return newQuery;
                 } else {
                    return { elements: [] }; // Return empty set for invalid selectors
                 }
            }

            $.fn = {}; // Keep for potential Semantic UI fallback check
            
            // Simple document ready function
            function documentReady(fn) {
                if (document.readyState !== 'loading') {
                    fn();
                } else {
                    document.addEventListener('DOMContentLoaded', fn);
                }
            }
        } 

        // Initialize dropdown functionality (Semantic UI or fallback)
        function initDropdown() {
            // æ£€æŸ¥æ˜¯å¦æœ‰å¯ç”¨çš„Semantic UI
            if (typeof $ !== 'undefined' && typeof $.fn.dropdown !== 'undefined') {
                // ä½¿ç”¨Semantic UIçš„dropdown
                $('.ui.dropdown').dropdown();
                // Initialize checkbox
                $('.ui.checkbox').checkbox();
                // åˆå§‹åŒ–æŒ‰é’®
                $('.ui.button').each(function() {
                    $(this).on('click', function() {
                        // å¯¹äºè§†å›¾åˆ‡æ¢æŒ‰é’®ï¼Œåˆ‡æ¢ active çŠ¶æ€
                        if ($(this).parent().hasClass('view-switcher') || $(this).closest('.view-switcher').length) {
                            $(this).siblings().removeClass('active');
                            $(this).addClass('active');
                        }
                    });
                });
                return;
            }

            // ä»¥ä¸‹æ˜¯æ— Semantic UIæ—¶çš„å›é€€æ–¹æ¡ˆ
            const dropdown = document.getElementById('indent-dropdown');
            if (!dropdown) return;

            const textEl = dropdown.querySelector('.text, .default.text');
            const inputEl = dropdown.querySelector('input');
            const menuEl = dropdown.querySelector('.menu');

            dropdown.addEventListener('click', function(e) {
                this.classList.toggle('active');
                this.classList.toggle('visible');
                menuEl.classList.toggle('visible');
                e.stopPropagation();
            });

            menuEl.addEventListener('click', function(e) {
                const item = e.target.closest('.item');
                if (item) {
                    const value = item.getAttribute('data-value');
                    const text = item.textContent;
                    
                    inputEl.value = value;
                    if (textEl) textEl.textContent = text;
                    
                    // ç§»é™¤æ—§çš„active item
                    menuEl.querySelectorAll('.item').forEach(el => {
                        el.classList.remove('active', 'selected');
                    });
                    
                    // è®¾ç½®æ–°çš„active item
                    item.classList.add('active', 'selected');
                    
                    dropdown.classList.remove('active', 'visible');
                    menuEl.classList.remove('visible');
                }
            });

            document.addEventListener('click', function() {
                dropdown.classList.remove('active', 'visible');
                menuEl.classList.remove('visible');
            });
            
            // åˆå§‹åŒ–æŒ‰é’®çš„å›é€€æ–¹æ¡ˆ
            const initButtons = function() {
                // ä¸ºè§†å›¾åˆ‡æ¢æŒ‰é’®æ·»åŠ åˆ‡æ¢åŠŸèƒ½
                const viewButtons = document.querySelectorAll('.view-switcher .ui.button');
                viewButtons.forEach(button => {
                    button.addEventListener('click', function() {
                        // ç§»é™¤æ‰€æœ‰æ¿€æ´»çŠ¶æ€
                        viewButtons.forEach(btn => btn.classList.remove('active'));
                        // ä¸ºå½“å‰æŒ‰é’®æ·»åŠ æ¿€æ´»çŠ¶æ€
                        this.classList.add('active');
                    });
                });
            };
            
            initButtons();
        }

        // Function to create Tree View HTML
        function createTreeView(jsonObj) {
            const contentDiv = document.createElement('div');
            contentDiv.className = 'tree-content';
            
            // é€’å½’æ„å»º JSON ç»“æ„
            function buildJsonItem(obj, key = null) {
                const isArray = Array.isArray(obj);
                const isObject = obj !== null && typeof obj === 'object';
                const itemDiv = document.createElement('div');
                itemDiv.className = 'json-item';
                
                // ä¸ºå¯¹è±¡å’Œæ•°ç»„æ·»åŠ å¯ç‚¹å‡»å±æ€§
                if (isObject) {
                    itemDiv.setAttribute('data-expandable', 'true');
                }
                
                // ç”Ÿæˆå½“å‰è¡Œå†…å®¹
                let content = '';
                
                // æ·»åŠ é”®åå’Œå†’å·ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
                if (key !== null) {
                    if (typeof key === 'number') {
                        content += `<span class="key array-index">${key}:</span> `;
                    } else {
                        content += `<span class="key">"${key}":</span> `;
                    }
                }
                
                // ä¸ºå¯¹è±¡å’Œæ•°ç»„æ·»åŠ å±•å¼€/æŠ˜å å›¾æ ‡
                if (isObject) {
                    const expandIcon = document.createElement('span');
                    expandIcon.className = 'expand-icon';
                    expandIcon.onclick = function(e) {
                        e.stopPropagation(); // é˜²æ­¢äº‹ä»¶å†’æ³¡
                        const parentItem = this.parentNode;
                        parentItem.classList.toggle('expanded');
                    };
                    itemDiv.appendChild(expandIcon);
                    
                    // æ·»åŠ å·¦æ‹¬å·ï¼ˆä¸æ–‡æœ¬è§†å›¾æ ¼å¼ä¸€è‡´ï¼‰
                    content += `<span class="brace">${isArray ? '[' : '{'}</span>`;
                    
                    // è®¡ç®—å­é¡¹æ•°é‡
                    const childCount = isArray ? obj.length : Object.keys(obj).length;
                    const itemText = childCount === 1 ? 'item' : 'items';
                    
                    // æ·»åŠ æŠ˜å æ—¶æ˜¾ç¤ºçš„å­é¡¹æ•°é‡æç¤º
                    content += `<span class="collapsed-indicator">${childCount} ${itemText}</span>`;
                    
                    itemDiv.innerHTML += content;
                    
                    // åˆ›å»ºå­é¡¹çš„å®¹å™¨
                    const childrenDiv = document.createElement('div');
                    childrenDiv.className = 'json-children';
                    
                    // å¤„ç†ç©ºå¯¹è±¡/æ•°ç»„
                    if (isArray && obj.length === 0) {
                        childrenDiv.innerHTML = '<div class="json-item"><em>/* empty array */</em></div>';
                    } else if (!isArray && Object.keys(obj).length === 0) {
                        childrenDiv.innerHTML = '<div class="json-item"><em>/* empty object */</em></div>';
                    } else {
                        // é€’å½’å¤„ç†å­é¡¹
                        let childKeys = isArray ? [...Array(obj.length).keys()] : Object.keys(obj);
                        
                        childKeys.forEach((childKey) => {
                            const childValue = obj[childKey];
                            const childContent = buildJsonItem(childValue, childKey);
                            childrenDiv.appendChild(childContent);
                        });
                    }
                    
                    // æ·»åŠ å³æ‹¬å·
                    childrenDiv.innerHTML += `<div class="json-item"><span class="brace">${isArray ? ']' : '}'}</span></div>`;
                    
                    // ä¸ºå¤–éƒ¨å®¹å™¨æ·»åŠ å³æ‹¬å·ï¼ˆåœ¨æŠ˜å æ—¶æ˜¾ç¤ºï¼‰
                    const closeBrace = document.createElement('span');
                    closeBrace.className = 'brace collapsed-brace';
                    closeBrace.textContent = isArray ? ']' : '}';
                    itemDiv.appendChild(childrenDiv);
                    itemDiv.appendChild(closeBrace);
                    
                    itemDiv.classList.add('expanded'); // é»˜è®¤å±•å¼€
                    
                    return itemDiv;
                } else {
                    // åŸºæœ¬ç±»å‹å€¼çš„å¤„ç†
                    const valueType = (obj === null) ? 'null' : typeof obj;
                    let displayValue = JSON.stringify(obj);
                    
                    // ä¸ºå­—ç¬¦ä¸²æ·»åŠ é¢œè‰²
                    if (valueType === 'string') {
                        content += `<span class="value string">${displayValue}</span>`;
                    } else if (valueType === 'number') {
                        content += `<span class="value number">${displayValue}</span>`;
                    } else if (valueType === 'boolean') {
                        content += `<span class="value boolean">${displayValue}</span>`;
                    } else if (valueType === 'null') {
                        content += `<span class="value null">${displayValue}</span>`;
                    } else {
                        content += `<span class="value">${displayValue}</span>`;
                    }
                    
                    itemDiv.innerHTML += content;
                    
                    return itemDiv;
                }
            }
            
            const rootItem = buildJsonItem(jsonObj);
            contentDiv.appendChild(rootItem);
            
            // è¿”å›åˆ›å»ºçš„æ ‘è§†å›¾
            return contentDiv.outerHTML;
        }

        // Function to highlight JSON text
        function highlightJSON(json) {
            if (!json) return '';
            
            // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é… JSON éƒ¨åˆ†
            const tokenized = json
                // æ·»åŠ å¯¹å­—ç¬¦ä¸²çš„å¤„ç†
                .replace(/"(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?/g, match => {
                    // é”®åå¸¦å†’å·
                    if (match.endsWith(':')) {
                        return `<span class="key">${match.slice(0, -1)}</span><span class="colon">:</span>`;
                    }
                    // æ™®é€šå­—ç¬¦ä¸²
                    return `<span class="value string">${match}</span>`;
                })
                // æ•°å­—
                .replace(/\b(-?)(0|[1-9][0-9]*)(\.[0-9]+)?([eE][+-]?[0-9]+)?\b/g, 
                    '<span class="value number">$&</span>')
                // å¸ƒå°”å€¼å’Œ null
                .replace(/\b(true|false|null)\b/g, 
                    '<span class="value $1">$&</span>')
                // æ‹¬å·
                .replace(/[\{\}]/g, 
                    '<span class="brace">$&</span>')
                .replace(/[\[\]]/g, 
                    '<span class="bracket">$&</span>')
                // é€—å·
                .replace(/,/g, 
                    '<span class="comma">,</span>');
                
            return tokenized;
        }

        // Function to update line numbers
        function updateLineNumbers() {
            const linesDiv = document.getElementById('line-numbers');
            const textarea = document.getElementById('json-input');
            if (!linesDiv || !textarea) return;

            try {
                const lines = textarea.value.split('\n');
                const lineCount = lines.length;
                let linesHtml = '';
                for (let i = 1; i <= lineCount; i++) {
                    linesHtml += i + '<br>';
                }
                linesDiv.innerHTML = linesHtml;
            } catch (e) {
                console.error("Error updating line numbers:", e);
                linesDiv.innerHTML = '1'; // Fallback
            }
        }
        
        // Document ready function
        (function() {
            // Try to use jQuery if available, otherwise use our fallback
            const ready = (typeof jQuery !== 'undefined') ? jQuery : documentReady;
            
            ready(function() {
                // Initialize dropdowns if Semantic UI is not available
                if (typeof $.fn.dropdown === 'undefined') {
                    initDropdown();
                } else {
                    $('.ui.dropdown').dropdown();
                }
                
                // DOM Elements
                const jsonInput = $('#json-input');
                const highlightedJson = $('#highlighted-json');
                const lineNumbers = $('#line-numbers');
                const treeViewContainer = $('#json-tree');
                const textViewContainer = $('#text-view');
                const formatBtn = $('#format-btn');
                const minifyBtn = $('#minify-btn');
                const validateBtn = $('#validate-btn');
                const errorMessage = $('#error-message');
                const indentDropdown = $('#indent-dropdown');
                const copyBtn = $('#copy-btn');
                const clearBtn = $('#clear-btn');
                const statusMessage = $('#status-message');
                const charCount = $('#char-count');
                const viewSwitcherBtns = $(".view-switcher .button");
                
                let currentJson = null; // Store parsed JSON
                let currentView = 'tree'; // Set to tree to ensure tree view renders

                // Sample JSON for initial demo
                const sampleJson = {
                    "name": "JSON Formatter Tool",
                    "description": "A tool to format, validate and beautify JSON data",
                    "features": ["Format", "Minify", "Validate"],
                    "settings": {
                        "indentation": 2,
                        "theme": "light"
                    },
                    "isAwesome": true,
                    "version": 1.0,
                    "nested": {
                        "level1": [1, 2, {"deep": true}]
                    }
                };
                
                // Set sample JSON
                jsonInput.val(JSON.stringify(sampleJson, null, 2));
                try { currentJson = JSON.parse(jsonInput.val()); } catch(e) { currentJson = null; }
                updateCharCount();
                updateLineNumbers();
                renderTreeView(); // Initial render
                
                // è®¾ç½®åˆå§‹å¸ƒå±€æ¯”ä¾‹
                document.getElementById('text-view').style.flex = '0 0 45%';
                document.querySelector('.tree-container').style.flex = '1 1 auto';
                
                // Remove view switcher functionality since both views are visible
                viewSwitcherBtns.hide();
                
                // Update highlighted content - no longer needed for side-by-side view
                function updateHighlightedContent() {
                    // Function simplified since we're using direct edit now
                }
                
                // Update character count
                function updateCharCount() {
                    const count = jsonInput.val().length;
                    charCount.text(`Characters: ${count.toLocaleString()}`);
                }

                // Render Tree View
                function renderTreeView() {
                    // Always attempt to render the tree regardless of view mode
                    if (currentJson) {
                        const startTime = performance.now();
                        try {
                            const treeHtml = createTreeView(currentJson);
                            treeViewContainer.html(treeHtml);
                            
                            // ç¡®ä¿åªæœ‰ä¸‰è§’å½¢å›¾æ ‡å¯ä»¥è§¦å‘å±•å¼€/æŠ˜å 
                            if (typeof $ !== 'undefined') {
                                // ç¡®ä¿åªæœ‰ä¸‰è§’å½¢å›¾æ ‡å¯ä»¥è§¦å‘å±•å¼€/æŠ˜å 
                                $('#json-tree').off('click');
                                // ä¸ºexpand-iconé‡æ–°ç»‘å®šäº‹ä»¶ï¼Œç¡®ä¿å®ƒæ­£å¸¸å·¥ä½œ
                                $('#json-tree').on('click', '.expand-icon', function(e) {
                                    const parentItem = this.parentNode;
                                    parentItem.classList.toggle('expanded');
                                    e.stopPropagation();
                                });
                            } else {
                                // åŸç”Ÿ JavaScript å›é€€
                                const container = document.getElementById('json-tree');
                                container.removeEventListener('click', container.clickHandler);
                                
                                // æ·»åŠ ä¸“é—¨é’ˆå¯¹expand-iconçš„ç‚¹å‡»å¤„ç†
                                container.clickHandler = function(e) {
                                    if (e.target.classList.contains('expand-icon')) {
                                        const parentItem = e.target.parentNode;
                                        parentItem.classList.toggle('expanded');
                                        e.stopPropagation();
                                    }
                                };
                                container.addEventListener('click', container.clickHandler);
                            }

                            const endTime = performance.now();
                            statusMessage.text(`Tree rendered in ${(endTime - startTime).toFixed(2)}ms`);
                        } catch (e) {
                            console.error("Error rendering tree:", e);
                            treeViewContainer.html('<p style="color: red;">Error rendering tree view: ' + e.message + '</p>');
                            statusMessage.text(`Error rendering tree.`);
                        }
                    } else {
                        treeViewContainer.html('<p style="color: #888;">Enter valid JSON to see tree view</p>'); // Clear if no valid JSON
                    }
                }
                
                // Input change event with real-time tree update
                jsonInput.on('input', function() {
                    errorMessage.addClass('hidden'); // Hide error on new input
                    statusMessage.text('');
                    updateCharCount();
                    updateLineNumbers();
                    
                    try { 
                        // Only try to parse if it's not empty
                        if (jsonInput.val().trim()) {
                            currentJson = JSON.parse(jsonInput.val());
                            // Real-time update of tree view
                            renderTreeView();
                        } else {
                            currentJson = null;
                            treeViewContainer.html(''); // Clear tree view
                        }
                    } catch(e) { 
                        currentJson = null;
                        // Don't show error during typing
                    }
                });

                // Sync scroll between textarea and line numbers
                jsonInput.on('scroll', function() {
                    // è·å–è¡Œå·å®¹å™¨
                    const lineNumbers = document.getElementById('line-numbers');
                    if (lineNumbers) {
                        lineNumbers.scrollTop = this.scrollTop;
                    }
                });
                
                // Format JSON
                formatBtn.on('click', function() {
                    if ($(this).hasClass('disabled')) return; // é˜»æ­¢æ ‘æ¨¡å¼ä¸‹çš„æ“ä½œ
                    formatJson();
                });
                
                // Minify JSON
                minifyBtn.on('click', function() {
                    if ($(this).hasClass('disabled')) return; // é˜»æ­¢æ ‘æ¨¡å¼ä¸‹çš„æ“ä½œ
                    minifyJson();
                });
                
                // Validate JSON
                validateBtn.on('click', function() {
                    if ($(this).hasClass('disabled')) return; // é˜»æ­¢æ ‘æ¨¡å¼ä¸‹çš„æ“ä½œ
                    validateJson();
                });
                
                // Clear input
                clearBtn.on('click', function() {
                    jsonInput.val('');
                    errorMessage.addClass('hidden');
                    statusMessage.text('');
                    currentJson = null;
                    updateCharCount();
                    updateLineNumbers();
                    treeViewContainer.html(''); // Clear tree view
                });
                
                // Copy output
                copyBtn.on('click', function() {
                    // Copy raw text regardless of view
                    const output = jsonInput.val();
                    copyToClipboard(output);
                    
                    statusMessage.text('Copied to clipboard!');
                    setTimeout(() => {
                        statusMessage.text('');
                    }, 2000);
                });

                // Format JSON function
                function formatJson() {
                    try {
                        const startTime = performance.now();
                        const content = jsonInput.val().trim();
                        if (content) {
                            let processedContent = content;
                            
                            // Apply JSON repair if checkbox is checked
                            const shouldRepair = $('#fix-json-checkbox input').is(':checked');
                            if (shouldRepair) {
                                processedContent = repairJson(content);
                            }
                            
                            currentJson = JSON.parse(processedContent); // Update currentJson
                            const indent = getIndentation();
                            const formatted = JSON.stringify(currentJson, null, indent);
                            jsonInput.val(formatted);
                            errorMessage.addClass('hidden');
                            
                            const endTime = performance.now();
                            statusMessage.text(`Formatted in ${(endTime - startTime).toFixed(2)}ms`);
                            updateCharCount();
                            updateLineNumbers();
                            
                            // Success animation for button
                            formatBtn.addClass('positive').delay(1000).queue(function(){
                                $(this).removeClass('positive').dequeue();
                            });
                            
                            // Always render tree view
                            renderTreeView();
                        }
                    } catch (e) {
                        showError(e.message);
                        currentJson = null; // Invalidate JSON on error
                        treeViewContainer.html(''); // Clear tree on error
                    }
                }
                
                // Minify JSON function
                function minifyJson() {
                    try {
                        const startTime = performance.now();
                        const content = jsonInput.val().trim();
                        
                        // Apply JSON repair if checkbox is checked
                        const shouldRepair = $('#fix-json-checkbox input').is(':checked');
                        if (shouldRepair && content) {
                            const repaired = repairJson(content);
                            currentJson = JSON.parse(repaired);
                        } else {
                            currentJson = JSON.parse(content);
                        }
                        
                        const minified = JSON.stringify(currentJson);
                        jsonInput.val(minified + '\n'); // Add line break at the end
                        errorMessage.addClass('hidden');

                        const endTime = performance.now();
                        statusMessage.text(`Minified in ${(endTime - startTime).toFixed(2)}ms`);
                        updateCharCount();
                        updateLineNumbers();
                        
                        // Success animation for button
                        minifyBtn.addClass('positive').delay(1000).queue(function(){
                            $(this).removeClass('positive').dequeue();
                        });
                        
                        renderTreeView(); // Update tree view
                    } catch (e) {
                        showError(e.message);
                        currentJson = null; // Invalidate JSON on error
                        treeViewContainer.html(''); // Clear tree on error
                    }
                }
                
                // Validate JSON function
                function validateJson() {
                    try {
                        const startTime = performance.now();
                        const content = jsonInput.val().trim();
                        
                        // Apply JSON repair if checkbox is checked
                        const shouldRepair = $('#fix-json-checkbox input').is(':checked');
                        if (shouldRepair && content) {
                            const repaired = repairJson(content);
                            currentJson = JSON.parse(repaired);
                            // If repaired successfully, update textarea with fixed JSON
                            if (repaired !== content) {
                                jsonInput.val(repaired);
                                updateCharCount();
                                updateLineNumbers();
                            }
                        } else {
                            currentJson = JSON.parse(content);
                        }
                        
                        errorMessage.addClass('hidden');
                        
                        const endTime = performance.now();
                        statusMessage.text(`Valid JSON! Validated in ${(endTime - startTime).toFixed(2)}ms`);
                        
                        // Success animation for button
                        validateBtn.addClass('positive').delay(1000).queue(function(){
                            $(this).removeClass('positive').dequeue();
                        });
                        
                        renderTreeView(); // Update tree view
                    } catch (e) {
                        showError(e.message);
                        currentJson = null; // Invalidate JSON on error
                        treeViewContainer.html(''); // Clear tree on error
                    }
                }
                
                // Repair JSON function to fix common syntax errors
                function repairJson(jsonString) {
                    if (!jsonString) return jsonString;
                    
                    let repaired = jsonString;
                    
                    // 1. Replace Python/JavaScript specific values with JSON equivalents
                    repaired = repaired
                        .replace(/\bNone\b/g, 'null')     // Python None -> null
                        .replace(/\bTrue\b/g, 'true')     // Python True -> true
                        .replace(/\bFalse\b/g, 'false')   // Python False -> false
                        .replace(/\bundefined\b/g, 'null') // JavaScript undefined -> null
                        .replace(/\bNaN\b/g, 'null');     // JavaScript NaN -> null
                    
                    // 2. Fix trailing commas in arrays and objects
                    repaired = repaired
                        .replace(/,\s*([}\]])/g, '$1');   // Remove trailing commas
                    
                    // 3. Convert single quotes to double quotes for property names and string values
                    // This is more complex as we need to handle nested quotes and escaping
                    
                    // Step 1: First handle property names with single quotes
                    repaired = repaired.replace(/'([^']+)'\s*:/g, function(match, p1) {
                        // Escape any double quotes in the property name
                        return `"${p1.replace(/"/g, '\\"')}":`; 
                    });
                    
                    // Step 2: Handle string values with single quotes
                    // This regex finds single-quoted strings not followed by a colon (which would be a property name)
                    const singleQuoteRegex = /'((?:[^'\\]|\\.)*)'/g;
                    repaired = repaired.replace(singleQuoteRegex, function(match, p1) {
                        // Replace with double-quoted string, escaping any double quotes
                        return `"${p1.replace(/"/g, '\\"')}"`;
                    });
                    
                    // 4. Add quotes to unquoted property names
                    repaired = repaired.replace(/(\{|\,)\s*([a-zA-Z0-9_$]+)\s*:/g, '$1"$2":');
                    
                    return repaired;
                }
                
                // Get indentation setting
                function getIndentation() {
                    let value;
                    
                    // ç›´æ¥ä½¿ç”¨Semantic UIçš„dropdown API
                    if (typeof $ !== 'undefined' && typeof $.fn.dropdown !== 'undefined') {
                        value = $('#indent-dropdown').dropdown('get value');
                    } else {
                        // å›é€€æ–¹æ¡ˆ
                        const input = document.querySelector('#indent-dropdown input');
                        value = input ? input.value : '2';
                    }
                    
                    if (value === 'tab') {
                        return '\t';
                    }
                    return parseInt(value) || 2;
                }
                
                // Show error message
                function showError(message) {
                    errorMessage.text('Error: ' + message);
                    errorMessage.removeClass('hidden');
                    statusMessage.text('');
                    // Semantic UI negative button animation
                    validateBtn.addClass('negative').delay(1000).queue(function(){
                        $(this).removeClass('negative').dequeue();
                    });
                }
                
                // Copy to clipboard function
                function copyToClipboard(text) {
                    if (!navigator.clipboard) {
                        // Fallback for older browsers
                        const textarea = document.createElement('textarea');
                        textarea.value = text;
                        textarea.style.position = 'fixed'; // Prevent scrolling to bottom
                        document.body.appendChild(textarea);
                        textarea.focus();
                        textarea.select();
                        try {
                            document.execCommand('copy');
                        } catch (err) {
                            console.error('Fallback: Oops, unable to copy', err);
                        }
                        document.body.removeChild(textarea);
                        return;
                    }
                    navigator.clipboard.writeText(text).then(function() {
                        /* success */
                    }, function(err) {
                        console.error('Async: Could not copy text: ', err);
                    });
                }
                
                // Format on load
                formatJson();
                
                // æ·»åŠ æ‹–æ‹½åˆ†éš”æ¡çš„åŠŸèƒ½
                initResizer();
                
                // åˆå§‹åŒ–æ‹–æ‹½åˆ†éš”æ¡åŠŸèƒ½
                function initResizer() {
                    const resizer = document.getElementById('resizer');
                    const textView = document.getElementById('text-view');
                    const treeContainer = document.querySelector('.tree-container');
                    
                    // æ£€æµ‹æ˜¯å¦ä¸ºç§»åŠ¨è®¾å¤‡
                    const isMobile = window.innerWidth <= 700;
                    
                    if (isMobile) {
                        // ç§»åŠ¨è®¾å¤‡ä¸‹è®¾ç½®åˆå§‹å¸ƒå±€
                        textView.style.flex = '1';
                        treeContainer.style.flex = '1';
                        
                        // ç§»åŠ¨è®¾å¤‡ä¸‹çš„åˆ†éš”æ¡é€»è¾‘
                        const mobileResize = function(e) {
                            const y = e.clientY || e.touches[0].clientY;
                            const containerHeight = document.querySelector('.view-container').offsetHeight;
                            const textViewHeight = Math.max(150, Math.min(y, containerHeight - 200));
                            const textViewPercent = (textViewHeight / containerHeight) * 100;
                            
                            textView.style.flex = `0 0 ${textViewPercent}%`;
                        };
                        
                        // ç§»åŠ¨è®¾å¤‡ä¸‹çš„è§¦æ‘¸å’Œé¼ æ ‡äº‹ä»¶å¤„ç†
                        resizer.addEventListener('touchstart', function(e) {
                            document.addEventListener('touchmove', mobileResize);
                            document.addEventListener('touchend', function() {
                                document.removeEventListener('touchmove', mobileResize);
                            }, { once: true });
                        });
                        
                        resizer.addEventListener('mousedown', function(e) {
                            document.addEventListener('mousemove', mobileResize);
                            document.addEventListener('mouseup', function() {
                                document.removeEventListener('mousemove', mobileResize);
                            }, { once: true });
                        });
                    } else {
                        // æ¡Œé¢ç‰ˆåˆ†éš”æ¡æ‹–æ‹½é€»è¾‘
                        let x = 0;
                        let textViewWidth = 0;
                        
                        const mouseDownHandler = function(e) {
                            x = e.clientX;
                            
                            const textViewRect = textView.getBoundingClientRect();
                            textViewWidth = textViewRect.width;
                            
                            document.addEventListener('mousemove', mouseMoveHandler);
                            document.addEventListener('mouseup', mouseUpHandler);
                            
                            e.preventDefault();
                        };
                        
                        const mouseMoveHandler = function(e) {
                            const dx = e.clientX - x;
                            
                            const containerWidth = document.querySelector('.view-container').offsetWidth;
                            const newTextViewWidth = Math.max(100, Math.min(textViewWidth + dx, containerWidth - 150));
                            const newTextViewPercent = (newTextViewWidth / containerWidth) * 100;
                            
                            textView.style.flex = `0 0 ${newTextViewPercent}%`;
                        };
                        
                        const mouseUpHandler = function() {
                            document.removeEventListener('mousemove', mouseMoveHandler);
                            document.removeEventListener('mouseup', mouseUpHandler);
                        };
                        
                        // æ·»åŠ äº‹ä»¶ç›‘å¬
                        resizer.addEventListener('mousedown', mouseDownHandler);
                    }
                    
                    // çª—å£å¤§å°å˜åŒ–æ—¶é‡æ–°åˆå§‹åŒ–
                    window.addEventListener('resize', function() {
                        const newIsMobile = window.innerWidth <= 700;
                        if (newIsMobile !== isMobile) {
                            // ç§»é™¤æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨
                            resizer.replaceWith(resizer.cloneNode(true));
                            // é‡æ–°åˆå§‹åŒ–
                            initResizer();
                        }
                    });
                }
            });
        })();
    </script>
</body>
</html> 