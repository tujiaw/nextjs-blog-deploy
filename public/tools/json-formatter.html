<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON Formatter Tool</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css">
    <style>
        html, body {
            padding: 0;
            margin: 0;
            height: 100%;
            width: 100%;
            overflow: hidden;
            background-color: #f8f8f8;
            font-size: 14px; /* Base font size */
        }
        body {
            display: flex;
            flex-direction: column;
        }
        .container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
        }
        .ui.segment, .segment {
            border: 1px solid rgba(34,36,38,.15);
            border-radius: 0;
            box-shadow: none;
            background-color: white;
            padding: 1em;
            margin: 0;
        }
        .view-container {
            flex: 1;
            display: flex; /* Using flexbox for side-by-side layout */
            overflow: hidden;
            position: relative; /* Needed for error message absolute positioning */
            background-color: white;
        }
        #line-numbers {
            font-family: monospace;
            padding: 10px 5px 10px 10px;
            background-color: #f7f7f7;
            color: #aaa;
            text-align: right;
            overflow: hidden;
            user-select: none;
            border-right: 1px solid #ddd;
            font-size: 0.9rem;
            line-height: 1.5;
            width: 40px;
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            z-index: 3;
            overflow-y: auto;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE and Edge */
        }
        #line-numbers::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }
        #json-input {
            font-family: monospace;
            resize: none;
            width: calc(100% - 40px); /* 减去行号宽度 */
            height: 100%;
            padding: 10px;
            box-sizing: border-box;
            flex: 1;
            overflow: auto;
            white-space: pre; /* Default to no wrap for formatted JSON */
            /* word-wrap will be set dynamically when minified */
            border: none;
            border-radius: 0;
            outline: none;
            font-size: 0.9rem;
            line-height: 1.5;
            position: absolute;
            top: 0;
            left: 0;
            color: rgba(0,0,0,0.8);
            background: white;
            z-index: 2;
        }
        .input-container {
            position: relative;
            flex: 1;
            display: flex;
            flex-direction: row; /* Default to row for text view + lines */
            overflow: hidden;
        }
        .tree-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        #json-tree {
            flex: 1;
            overflow: auto;
            padding: 10px;
            font-family: monospace;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        .error-message {
            color: #db2828;
            font-weight: bold;
            padding: 5px 10px;
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: rgba(255, 240, 240, 0.9);
            border-top: 1px solid #db2828;
            z-index: 10; 
        }
        .header-container {
            display: flex;
            align-items: center;
            padding: 10px;
            background-color: #fff;
            border-bottom: 1px solid #ddd;
            flex-wrap: wrap; /* Allow wrapping */
            gap: 10px; /* Add gap between elements */
        }
        .header {
            margin: 0;
            display: flex;
            align-items: center;
            font-size: 1.1rem;
            margin-right: 15px;
            white-space: nowrap;
        }
        .buttons {
            display: flex;
            flex-wrap: nowrap; /* Prevent button wrapping within the group */
            gap: 5px;
        }
        /* Make buttons more compact */
        .ui.tiny.button {
            padding: 0.5em 0.7em !important;
            font-size: 0.85rem !important;
            height: 28px !important;
        }
        /* Make button group buttons match height */
        .ui.buttons .ui.button {
            padding: 0.5em 0.7em !important;
            font-size: 0.85rem !important;
            height: 28px !important;
        }
        /* Reduce dropdown width */
        .ui.tiny.selection.dropdown {
            min-width: 90px !important;
            padding: 0.5em 0.7em !important;
            font-size: 0.85rem !important;
            height: 28px !important;
            line-height: 1 !important;
            display: flex !important;
            align-items: center !important;
        }
        /* Fix dropdown icon alignment */
        .ui.dropdown .dropdown.icon {
            line-height: 1 !important;
            margin: 0 0 0 0.5em !important;
            height: auto !important;
            position: absolute !important;
            right: 0.4em !important;
            top: 50% !important;
            transform: translateY(-50%) !important;
        }
        /* Fix the text alignment in dropdown */
        .ui.selection.dropdown .text {
            margin-right: 1em !important;
            line-height: 1 !important;
        }
        .dropdown {
            position: relative;
            display: inline-block;
        }
        .dropdown .menu {
            position: absolute;
            top: 100%;
            right: 0; /* Align dropdown to the right */
            left: auto;
            z-index: 1000;
            display: none;
            min-width: 6rem;
            background-color: white;
            border: 1px solid rgba(34,36,38,.15);
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,.15);
        }
        .dropdown.active .menu {
            display: block;
        }
        .dropdown .item {
            padding: 0.2em 0.4em;
            cursor: pointer;
        }
        .dropdown .item:hover {
            background-color: rgba(0,0,0,.05);
        }
        .dropdown .text {
            margin-right: 2px;
        }
        .hidden {
            display: none !important;
        }
        .status-bar {
            background-color: #f5f5f5;
            border-top: 1px solid #ddd;
            padding: 3px 10px;
            font-size: 0.8rem;
            color: #555;
            display: flex;
            justify-content: space-between;
        }
        .icon {
            display: inline-block;
            width: 1.18em;
            height: 1em;
            font-style: normal;
            text-decoration: inherit;
            text-align: center;
            speak: none;
        }
        /* Fallback icons using Unicode */
        .trash.icon:before { content: "🗑️"; }
        .copy.icon:before { content: "📋"; }
        .check.icon:before { content: "✓"; }
        .code.icon:before { content: "{ }"; }
        .dropdown.icon:before { content: "▼"; }

        /* Tree view styles */
        .json-tree {
            display: flex; /* 使用 flex 布局 */
            height: 100%; /* 确保树视图占满容器高度 */
            overflow: hidden; /* 防止树视图本身滚动 */
        }
        
        .tree-content {
            flex: 1;
            overflow: auto; /* 让内容区域可滚动 */
            padding-left: 5px;
            height: 100%; /* 确保内容区域占满高度 */
        }
        
        .expand-icon {
            cursor: pointer;
            display: inline-block;
            width: 16px;
            text-align: center;
            user-select: none;
            margin-right: 3px;
            margin-left: 3px;
            position: relative;
            top: 1px;
        }
        
        .expand-icon::before {
            content: "▶";
            font-size: 0.8em;
            color: #888;
        }
        
        .expanded > .expand-icon::before {
            content: "▼";
            color: #333;
        }
        
        .json-item {
            white-space: nowrap;
            margin: 0; /* 移除上下边距，使行高与文本视图一致 */
            line-height: 1.5; /* 确保与json-input相同的行高 */
            cursor: default; /* 改为默认光标，因为只有三角形可点击 */
        }
        
        /* 添加右括号对齐样式 */
        .json-item-wrapper {
            position: relative;
        }
        
        .json-item-wrapper .closing-brace {
            padding-left: 0; /* 移除左边距使其与左括号对齐 */
            line-height: 1.5;
        }
        
        .json-children {
            display: none;
            padding-left: 20px;
            line-height: 1.5; /* 确保子项也有相同的行高 */
        }
        
        .expanded > .json-children {
            display: block;
        }
        
        .collapsed-indicator {
            display: none;
            color: #888;
            padding: 0 3px;
            font-style: italic;
            margin-left: 2px;
        }
        
        .json-item:not(.expanded) > .collapsed-indicator {
            display: inline-block;
        }

        /* Make the expanded icons show only when expanded */
        .json-item:not(.expanded) > .expand-icon {
            position: relative;
            margin-right: 2px;
        }
        
        /* Make the collapsed brace appear only when collapsed */
        .collapsed-brace {
            display: none; /* 默认隐藏 */
            line-height: 1.5; /* 与其他元素保持一致的行高 */
        }
        
        .json-item:not(.expanded) > .collapsed-brace {
            display: inline-block; /* 折叠状态时显示 */
            margin-left: 3px;
        }

        /* 为不同类型的值添加颜色 - 用于两种视图 */
        .key {
            color: #0033B3; /* 亮蓝色 */
            font-weight: bold;
        }
        
        /* 为数组索引添加特殊颜色 */
        .key.array-index {
            color: #888888; /* 灰色 */
            font-weight: normal;
        }
        
        .value.string {
            color: #008000; /* 亮绿色 */
        }
        
        .value.number {
            color: #E67700; /* 亮橙色 */
        }
        
        .value.boolean, .value.null {
            color: #D53C4E; /* 亮红色 */
            font-weight: bold;
        }
        
        .brace, .bracket, .comma, .colon {
            color: #555555; /* 深灰色 */
        }

        @media (max-width: 700px) { /* Adjusted breakpoint */
            .header-container {
                flex-direction: column;
                align-items: flex-start;
                padding: 8px;
            }
            .tree-controls {
                margin-left: 0 !important;
                margin-top: 5px;
                width: 100%;
            }
            .tree-controls .buttons {
                width: 100%;
            }
            .view-container {
                flex-direction: column; /* Stack views on mobile */
            }
            #line-numbers {
                width: 40px;
                position: absolute;
                right: 0;
                top: 0;
                bottom: 0;
                overflow-y: auto;
                padding: 10px 5px;
            }
            #json-input {
                width: calc(100% - 40px);
            }
            .resizer {
                width: 100%;
                height: 6px;
                cursor: row-resize;
            }
            .buttons {
                margin-left: 0;
                width: 100%;
                justify-content: space-between;
                flex-wrap: wrap;
                gap: 5px;
            }
            .header {
                margin-bottom: 5px;
                font-size: 1rem;
            }
        }

        .disabled {
            opacity: 0.45 !important;
            cursor: default !important;
            pointer-events: none !important;
        }

        /* 添加分隔条样式 */
        .resizer {
            width: 6px;
            cursor: col-resize;
            background-color: #f0f0f0;
            border-left: 1px solid #ddd;
            border-right: 1px solid #ddd;
            z-index: 10;
        }
        .resizer:hover {
            background-color: #ddd;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-container">
            <h1 class="header">
                <span style="margin-left: 5px;">JSON Formatter</span>
            </h1>

            <div class="buttons">
                <button class="ui tiny primary button" id="format-btn">Format</button>
                <button class="ui tiny button" id="minify-btn">Minify</button>
                <button class="ui tiny button" id="sort-btn">Sort</button>
                <button class="ui tiny button" id="validate-btn">Validate</button>
                <button class="ui tiny button" id="copy-btn">Copy</button>
                <button class="ui tiny button" id="clear-btn">Clear</button>
                
                <div class="ui tiny selection dropdown" id="indent-dropdown">
                    <input type="hidden" name="indent" value="2">
                    <i class="dropdown icon"></i>
                    <div class="default text">2 Spaces</div>
                    <div class="menu">
                        <div class="item" data-value="2">2 Spaces</div>
                        <div class="item" data-value="4">4 Spaces</div>
                        <div class="item" data-value="tab">Tab</div>
                    </div>
                </div>
                
                <div class="ui tiny checkbox" id="fix-json-checkbox" style="margin-left: 10px; display: flex; align-items: center;">
                    <input type="checkbox" checked>
                    <label style="font-size: 0.85rem; cursor: pointer;">Fix JSON</label>
                </div>
            </div>
            
            <div class="tree-controls" style="margin-left: auto; display: flex; align-items: center;">
                <div class="ui tiny basic buttons">
                    <button class="ui tiny button" id="expand-all-btn">Expand All</button>
                    <button class="ui tiny button" id="collapse-all-btn">Collapse All</button>
                </div>
            </div>
        </div>

        <div class="view-container">
             <div class="input-container" id="text-view">
                 <textarea id="json-input" placeholder="Paste your JSON here..."></textarea>
                 <div id="line-numbers">1</div>
             </div>
             <div class="resizer" id="resizer"></div> <!-- 保留单个分隔条 -->
             <div class="tree-container">
                 <div id="json-tree" class="json-tree"></div> <!-- Tree view container -->
             </div>
             <div class="error-message hidden" id="error-message"></div>
        </div>
        
        <div class="status-bar">
            <div id="status-message"></div>
            <div id="char-count">Characters: 0</div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.js"></script>
    <script>
        // Fallback for jQuery if CDN fails
        if (typeof jQuery === 'undefined') {
            // Simple DOM manipulation functions
            function $(selector) {
                if (typeof selector === 'string') {
                    const elements = document.querySelectorAll(selector);
                    return {
                        elements: elements,
                        val: function(value) {
                            if (value === undefined) {
                                return this.elements[0] ? this.elements[0].value : '';
                            } else {
                                this.elements.forEach(el => el.value = value);
                                return this;
                            }
                        },
                        text: function(value) {
                            if (value === undefined) {
                                return this.elements[0] ? this.elements[0].textContent : '';
                            } else {
                                this.elements.forEach(el => el.textContent = value);
                                return this;
                            }
                        },
                        html: function(value) {
                             if (value === undefined) {
                                 return this.elements[0] ? this.elements[0].innerHTML : '';
                             } else {
                                 this.elements.forEach(el => el.innerHTML = value);
                                 return this;
                             }
                         },
                        addClass: function(className) {
                            this.elements.forEach(el => el.classList.add(className));
                            return this;
                        },
                        removeClass: function(className) {
                            this.elements.forEach(el => el.classList.remove(className));
                            return this;
                        },
                         css: function(prop, value) {
                             if (value === undefined) {
                                 // Simple getter for single property
                                 return this.elements[0] ? window.getComputedStyle(this.elements[0])[prop] : undefined;
                             } else {
                                 this.elements.forEach(el => el.style[prop] = value);
                                 return this;
                             }
                         },
                        find: function(childSelector) {
                            const children = [];
                            this.elements.forEach(el => {
                                const found = el.querySelectorAll(childSelector);
                                found.forEach(child => children.push(child));
                            });
                             // Return a new chainable object
                             const newQuery = { elements: children };
                             Object.assign(newQuery, this);
                             newQuery.elements = children; // Ensure elements are the found children
                             return newQuery;
                        },
                        on: function(event, callback) {
                            this.elements.forEach(el => el.addEventListener(event, callback));
                            return this;
                        },
                        // Basic implementation for scroll event
                         scrollTop: function(value) {
                             if (value === undefined) {
                                 return this.elements[0] ? this.elements[0].scrollTop : 0;
                             } else {
                                 this.elements.forEach(el => el.scrollTop = value);
                                 return this;
                             }
                         },
                         // Add delay and queue support for animations
                         delay: function(ms) {
                             this.delayTime = ms;
                             return this;
                         },
                         queue: function(callback) {
                             if (this.delayTime) {
                                 const self = this;
                                 setTimeout(function() {
                                     callback.call(self.elements[0]);
                                 }, this.delayTime);
                                 this.delayTime = 0;
                             } else {
                                 callback.call(this.elements[0]);
                             }
                             return this;
                         },
                         hide: function() {
                             this.elements.forEach(el => {
                                 el.style.display = 'none';
                             });
                             return this;
                         }
                    };
                } else if (typeof selector === 'function') {
                     // Handle document ready
                     documentReady(selector);
                     return undefined; // Return undefined for ready function
                 } else if (selector.nodeType || selector === window || selector === document) {
                     // Handle direct nodes, window, document
                     const newQuery = { elements: [selector] };
                     // Copy methods from prototype, but be careful not to overwrite 'elements'
                     Object.assign(newQuery, $().constructor.prototype);
                     newQuery.elements = [selector];
                     return newQuery;
                 } else {
                    return { elements: [] }; // Return empty set for invalid selectors
                 }
            }

            $.fn = {}; // Keep for potential Semantic UI fallback check
            
            // Simple document ready function
            function documentReady(fn) {
                if (document.readyState !== 'loading') {
                    fn();
                } else {
                    document.addEventListener('DOMContentLoaded', fn);
                }
            }
        } 

        // Initialize dropdown functionality (Semantic UI or fallback)
        function initDropdown() {
            // 检查是否有可用的Semantic UI
            if (typeof $ !== 'undefined' && typeof $.fn.dropdown !== 'undefined') {
                // 使用Semantic UI的dropdown
                $('.ui.dropdown').dropdown();
                // Initialize checkbox
                $('.ui.checkbox').checkbox();
                return;
            }

            // 以下是无Semantic UI时的回退方案
            const dropdown = document.getElementById('indent-dropdown');
            if (!dropdown) return;

            const textEl = dropdown.querySelector('.text, .default.text');
            const inputEl = dropdown.querySelector('input');
            const menuEl = dropdown.querySelector('.menu');

            dropdown.addEventListener('click', function(e) {
                this.classList.toggle('active');
                this.classList.toggle('visible');
                menuEl.classList.toggle('visible');
                e.stopPropagation();
            });

            menuEl.addEventListener('click', function(e) {
                const item = e.target.closest('.item');
                if (item) {
                    const value = item.getAttribute('data-value');
                    const text = item.textContent;
                    
                    inputEl.value = value;
                    if (textEl) textEl.textContent = text;
                    
                    // 移除旧的active item
                    menuEl.querySelectorAll('.item').forEach(el => {
                        el.classList.remove('active', 'selected');
                    });
                    
                    // 设置新的active item
                    item.classList.add('active', 'selected');
                    
                    dropdown.classList.remove('active', 'visible');
                    menuEl.classList.remove('visible');
                }
            });

            document.addEventListener('click', function() {
                dropdown.classList.remove('active', 'visible');
                menuEl.classList.remove('visible');
            });
        }

        // Function to create Tree View HTML
        function createTreeView(jsonObj) {
            const contentDiv = document.createElement('div');
            contentDiv.className = 'tree-content';
            
            // 递归构建 JSON 结构
            function buildJsonItem(obj, key = null) {
                // 确保样式只添加一次
                if (!document.getElementById('json-tree-styles')) {
                    const styleElement = document.createElement('style');
                    styleElement.id = 'json-tree-styles';
                    styleElement.textContent = `
                        .json-item-wrapper .closing-brace {
                            display: none;
                        }
                        .json-item-wrapper .json-item.expanded + .closing-brace {
                            display: block;
                        }
                    `;
                    document.head.appendChild(styleElement);
                }
                
                const isArray = Array.isArray(obj);
                const isObject = obj !== null && typeof obj === 'object';
                const itemDiv = document.createElement('div');
                itemDiv.className = 'json-item';
                
                // 为对象和数组添加可点击属性
                if (isObject) {
                    itemDiv.setAttribute('data-expandable', 'true');
                }
                
                // 生成当前行内容
                let content = '';
                
                // 添加键名和冒号（如果有的话）
                if (key !== null) {
                    if (typeof key === 'number') {
                        content += `<span class="key array-index">${key}:</span> `;
                    } else {
                        content += `<span class="key">"${key}":</span> `;
                    }
                }
                
                // 为对象和数组添加展开/折叠图标
                if (isObject) {
                    // 添加左括号（与文本视图格式一致）
                    content += `<span class="brace">${isArray ? '[' : '{'}</span>`;
                    
                    // 计算子项数量
                    const childCount = isArray ? obj.length : Object.keys(obj).length;
                    const itemText = childCount === 1 ? 'item' : 'items';
                    
                    // 创建展开/折叠图标
                    const expandIcon = document.createElement('span');
                    expandIcon.className = 'expand-icon';
                    expandIcon.onclick = function(e) {
                        e.stopPropagation(); // 防止事件冒泡
                        const parentItem = this.parentNode;
                        parentItem.classList.toggle('expanded');
                    };
                    
                    // 添加内容到 itemDiv
                    itemDiv.innerHTML += content;
                    
                    // 创建折叠时显示的容器（包含图标和文本）
                    const collapsedContent = document.createElement('span');
                    collapsedContent.className = 'collapsed-indicator';
                    collapsedContent.innerHTML = `${childCount} ${itemText}`;
                    
                    // 添加元素到 itemDiv
                    itemDiv.appendChild(expandIcon);
                    itemDiv.appendChild(collapsedContent);
                    
                    // 处理空对象/数组
                    if ((isArray && obj.length === 0) || (!isArray && Object.keys(obj).length === 0)) {
                        // 对于空对象/数组，直接返回简单的显示，不需要展开/折叠功能
                        const simpleDiv = document.createElement('div');
                        simpleDiv.className = 'json-item';
                        let content = '';
                        if (key !== null) {
                            if (typeof key === 'number') {
                                content += `<span class="key array-index">${key}:</span> `;
                            } else {
                                content += `<span class="key">"${key}":</span> `;
                            }
                        }
                        content += `<span class="brace">${isArray ? '[]' : '{}'}</span>`;
                        simpleDiv.innerHTML = content;
                        return simpleDiv;
                    }
                    
                    // 创建子项的容器
                    const childrenDiv = document.createElement('div');
                    childrenDiv.className = 'json-children';
                    
                    // 递归处理子项
                    let childKeys = isArray ? [...Array(obj.length).keys()] : Object.keys(obj);
                    
                    childKeys.forEach((childKey) => {
                        const childValue = obj[childKey];
                        const childContent = buildJsonItem(childValue, childKey);
                        childrenDiv.appendChild(childContent);
                    });
                    
                    // 为外部容器添加右括号（在折叠时显示）
                    const closeBrace = document.createElement('span');
                    closeBrace.className = 'brace collapsed-brace';
                    closeBrace.textContent = isArray ? ']' : '}';
                    
                    // 添加子项容器
                    itemDiv.appendChild(childrenDiv);
                    itemDiv.appendChild(closeBrace);
                    
                    // 创建一个与左括号对齐的右括号元素
                    const closingBraceDiv = document.createElement('div');
                    closingBraceDiv.className = 'json-item closing-brace';
                    closingBraceDiv.innerHTML = `<span class="brace">${isArray ? ']' : '}'}</span>`;
                    
                    // 将对齐的右括号元素添加到父元素中
                    const wrapper = document.createElement('div');
                    wrapper.className = 'json-item-wrapper';
                    wrapper.appendChild(itemDiv);
                    wrapper.appendChild(closingBraceDiv);
                    
                    itemDiv.classList.add('expanded'); // 默认展开
                    
                    return wrapper;
                } else {
                    // 基本类型值的处理
                    const valueType = (obj === null) ? 'null' : typeof obj;
                    let displayValue = JSON.stringify(obj);
                    
                    // 为字符串添加颜色
                    if (valueType === 'string') {
                        content += `<span class="value string">${displayValue}</span>`;
                    } else if (valueType === 'number') {
                        content += `<span class="value number">${displayValue}</span>`;
                    } else if (valueType === 'boolean') {
                        content += `<span class="value boolean">${displayValue}</span>`;
                    } else if (valueType === 'null') {
                        content += `<span class="value null">${displayValue}</span>`;
                    } else {
                        content += `<span class="value">${displayValue}</span>`;
                    }
                    
                    itemDiv.innerHTML += content;
                    
                    return itemDiv;
                }
            }
            
            const rootItem = buildJsonItem(jsonObj);
            contentDiv.appendChild(rootItem);
            
            // 返回创建的树视图
            return contentDiv.outerHTML;
        }

        // Function to update line numbers
        function updateLineNumbers() {
            const linesDiv = document.getElementById('line-numbers');
            const textarea = document.getElementById('json-input');
            if (!linesDiv || !textarea) return;

            try {
                const lines = textarea.value.split('\n');
                const lineCount = lines.length;
                let linesHtml = '';
                for (let i = 1; i <= lineCount; i++) {
                    linesHtml += i + '<br>';
                }
                linesDiv.innerHTML = linesHtml;
            } catch (e) {
                console.error("Error updating line numbers:", e);
                linesDiv.innerHTML = '1'; // Fallback
            }
        }
        
        // Document ready function
        (function() {
            // Try to use jQuery if available, otherwise use our fallback
            const ready = (typeof jQuery !== 'undefined') ? jQuery : documentReady;
            
            ready(function() {
                // Initialize dropdowns if Semantic UI is not available
                if (typeof $.fn.dropdown === 'undefined') {
                    initDropdown();
                } else {
                    $('.ui.dropdown').dropdown();
                }
                
                // DOM Elements
                const jsonInput = $('#json-input');
                const lineNumbers = $('#line-numbers');
                const treeViewContainer = $('#json-tree');
                const textViewContainer = $('#text-view');
                const formatBtn = $('#format-btn');
                const minifyBtn = $('#minify-btn');
                const sortBtn = $('#sort-btn');
                const validateBtn = $('#validate-btn');
                const errorMessage = $('#error-message');
                const indentDropdown = $('#indent-dropdown');
                const copyBtn = $('#copy-btn');
                const clearBtn = $('#clear-btn');
                const statusMessage = $('#status-message');
                const charCount = $('#char-count');
                const expandAllBtn = $('#expand-all-btn');
                const collapseAllBtn = $('#collapse-all-btn');
                
                let currentJson = null; // Store parsed JSON
                
                // 添加tab键转换为空格的功能
                jsonInput.on('keydown', function(e) {
                    if (e.key === 'Tab') {
                        e.preventDefault();
                        const spaces = ' '.repeat(getIndentation());
                        document.execCommand('insertText', false, spaces);
                    }
                });
                
                // Sample JSON for initial demo
                const sampleJson = {
                    "name": "JSON Formatter Tool",
                    "description": "A tool to format, validate and beautify JSON data",
                    "features": ["Format", "Minify", "Validate"],
                    "settings": {
                        "indentation": 2,
                        "theme": "light"
                    },
                    "isAwesome": true,
                    "version": 1.0,
                    "nested": {
                        "level1": [1, 2, {"deep": true}]
                    }
                };
                
                // Set sample JSON
                jsonInput.val(JSON.stringify(sampleJson, null, 2));
                try { currentJson = JSON.parse(jsonInput.val()); } catch(e) { currentJson = null; }
                updateCharCount();
                updateLineNumbers();
                renderTreeView(); // Initial render
                
                // 设置初始布局比例
                document.getElementById('text-view').style.flex = '0 0 45%';
                document.querySelector('.tree-container').style.flex = '1 1 auto';
                
                // Update character count
                function updateCharCount() {
                    const count = jsonInput.val().length;
                    charCount.text(`Characters: ${count.toLocaleString()}`);
                }

                // Render Tree View
                function renderTreeView() {
                    // Always attempt to render the tree regardless of view mode
                    if (currentJson) {
                        const startTime = performance.now();
                        try {
                            // 保存当前滚动位置
                            const treeContent = document.querySelector('.tree-content');
                            const previousScrollTop = treeContent ? treeContent.scrollTop : 0;
                            
                            const treeHtml = createTreeView(currentJson);
                            treeViewContainer.html(treeHtml);
                            
                            // 确保只有三角形图标可以触发展开/折叠
                            if (typeof $ !== 'undefined') {
                                // 确保只有三角形图标可以触发展开/折叠
                                $('#json-tree').off('click');
                                // 为expand-icon重新绑定事件，确保它正常工作
                                $('#json-tree').on('click', '.expand-icon', function(e) {
                                    const parentItem = this.parentNode;
                                    parentItem.classList.toggle('expanded');
                                    e.stopPropagation();
                                });
                            } else {
                                // 原生 JavaScript 回退
                                const container = document.getElementById('json-tree');
                                container.removeEventListener('click', container.clickHandler);
                                
                                // 添加专门针对expand-icon的点击处理
                                container.clickHandler = function(e) {
                                    if (e.target.classList.contains('expand-icon')) {
                                        const parentItem = e.target.parentNode;
                                        parentItem.classList.toggle('expanded');
                                        e.stopPropagation();
                                    }
                                };
                                container.addEventListener('click', container.clickHandler);
                            }

                            // 重新绑定树视图的滚动事件
                            const newTreeContent = document.querySelector('.tree-content');
                            if (newTreeContent) {
                                // 移除旧的事件监听器
                                newTreeContent.removeEventListener('scroll', newTreeContent.scrollHandler);
                                
                                // 创建新的事件处理函数
                                newTreeContent.scrollHandler = function() {
                                    const textarea = document.getElementById('json-input');
                                    if (textarea) {
                                        // 计算树视图的滚动比例
                                        const treeScrollRatio = this.scrollTop / (this.scrollHeight - this.clientHeight);
                                        // 计算文本框应该滚动到的位置
                                        const textareaScrollTop = treeScrollRatio * (textarea.scrollHeight - textarea.clientHeight);
                                        // 设置文本框的滚动位置
                                        textarea.scrollTop = textareaScrollTop;
                                    }
                                };
                                
                                // 添加新的事件监听器
                                newTreeContent.addEventListener('scroll', newTreeContent.scrollHandler);
                                
                                // 恢复之前的滚动位置
                                newTreeContent.scrollTop = previousScrollTop;
                            }

                            const endTime = performance.now();
                            statusMessage.text(`Tree rendered in ${(endTime - startTime).toFixed(2)}ms`);
                        } catch (e) {
                            console.error("Error rendering tree:", e);
                            treeViewContainer.html('<p style="color: red;">Error rendering tree view: ' + e.message + '</p>');
                            statusMessage.text(`Error rendering tree.`);
                        }
                    } else {
                        treeViewContainer.html('<p style="color: #888;">Enter valid JSON to see tree view</p>'); // Clear if no valid JSON
                    }
                }
                
                // 添加防抖动函数
                function debounce(func, wait) {
                    let timeout;
                    return function executedFunction(...args) {
                        const later = () => {
                            clearTimeout(timeout);
                            func(...args);
                        };
                        clearTimeout(timeout);
                        timeout = setTimeout(later, wait);
                    };
                }

                // 创建更新函数
                function updateJsonView() {
                    errorMessage.addClass('hidden'); // Hide error on new input
                    statusMessage.text('');
                    updateCharCount();
                    updateLineNumbers();
                    
                    try { 
                        // Only try to parse if it's not empty
                        if (jsonInput.val().trim()) {
                            currentJson = parseJson(jsonInput.val());
                            // Real-time update of tree view
                            renderTreeView();
                        } else {
                            currentJson = null;
                            treeViewContainer.html(''); // Clear tree view
                        }
                    } catch(e) { 
                        currentJson = null;
                        // Don't show error during typing
                    }
                }

                // 创建防抖动的更新函数
                const debouncedUpdate = debounce(updateJsonView, 500);

                // 使用防抖动的更新函数
                jsonInput.on('input', debouncedUpdate);

                // 添加一个标志位来防止循环触发
                let isScrolling = false;

                // Sync scroll between textarea and tree view
                jsonInput.on('scroll', function() {
                    if (isScrolling) return;
                    isScrolling = true;
                    
                    const treeContent = document.querySelector('.tree-content');
                    const lineNumbers = document.getElementById('line-numbers');
                    
                    // 同步行号滚动
                    if (lineNumbers) {
                        lineNumbers.scrollTop = this.scrollTop;
                    }
                    
                    // 同步树视图滚动
                    if (treeContent) {
                        const textareaScrollRatio = this.scrollTop / (this.scrollHeight - this.clientHeight);
                        const treeScrollTop = textareaScrollRatio * (treeContent.scrollHeight - treeContent.clientHeight);
                        treeContent.scrollTop = treeScrollTop;
                    }
                    
                    // 使用 setTimeout 确保在下一个事件循环中重置标志位
                    setTimeout(() => {
                        isScrolling = false;
                    }, 50);
                });
                
                // 修改树视图滚动同步
                const treeContent = document.querySelector('.tree-content');
                if (treeContent) {
                    treeContent.addEventListener('scroll', function() {
                        if (isScrolling) return;
                        isScrolling = true;
                        
                        const textarea = document.getElementById('json-input');
                        const lineNumbers = document.getElementById('line-numbers');
                        
                        if (textarea) {
                            const treeScrollRatio = this.scrollTop / (this.scrollHeight - this.clientHeight);
                            const textareaScrollTop = treeScrollRatio * (textarea.scrollHeight - textarea.clientHeight);
                            textarea.scrollTop = textareaScrollTop;
                            
                            // 同步行号滚动
                            if (lineNumbers) {
                                lineNumbers.scrollTop = textareaScrollTop;
                            }
                        }
                        
                        // 使用 setTimeout 确保在下一个事件循环中重置标志位
                        setTimeout(() => {
                            isScrolling = false;
                        }, 50);
                    });
                }
                
                // 统一的JSON解析方法
                function parseJson(content) {
                    // 先尝试直接解析
                    try {
                        return JSON.parse(content);
                    } catch (parseError) {
                        // 如果直接解析失败，且启用了修复选项，则尝试修复
                        if ($('#fix-json-checkbox input').is(':checked')) {
                            const repaired = repairJson(content);
                            return JSON.parse(repaired);
                        } else {
                            throw parseError;
                        }
                    }
                }
                
                // Format JSON
                formatBtn.on('click', function() {
                    if ($(this).hasClass('disabled')) return; // 阻止树模式下的操作
                    formatJson();
                });
                
                // Minify JSON
                minifyBtn.on('click', function() {
                    if ($(this).hasClass('disabled')) return; // 阻止树模式下的操作
                    minifyJson();
                });
                
                // Validate JSON
                validateBtn.on('click', function() {
                    if ($(this).hasClass('disabled')) return; // 阻止树模式下的操作
                    validateJson();
                });
                
                // Sort JSON
                sortBtn.on('click', function() {
                    if ($(this).hasClass('disabled')) return; // 阻止树模式下的操作
                    sortJson();
                });
                
                // Clear input
                clearBtn.on('click', function() {
                    jsonInput.val('');
                    errorMessage.addClass('hidden');
                    statusMessage.text('');
                    currentJson = null;
                    updateCharCount();
                    updateLineNumbers();
                    treeViewContainer.html(''); // Clear tree view
                });
                
                // Copy output
                copyBtn.on('click', function() {
                    // Copy raw text regardless of view
                    const output = jsonInput.val();
                    copyToClipboard(output);
                    
                    statusMessage.text('Copied to clipboard!');
                    setTimeout(() => {
                        statusMessage.text('');
                    }, 2000);
                });
                
                // Expand all tree nodes
                expandAllBtn.on('click', function() {
                    if ($(this).hasClass('disabled')) return;
                    
                    const startTime = performance.now();
                    $('#json-tree .json-item[data-expandable="true"]').addClass('expanded');
                    const endTime = performance.now();
                    
                    statusMessage.text(`All nodes expanded in ${(endTime - startTime).toFixed(2)}ms`);
                    setTimeout(() => {
                        statusMessage.text('');
                    }, 2000);
                });
                
                // Collapse all tree nodes
                collapseAllBtn.on('click', function() {
                    if ($(this).hasClass('disabled')) return;
                    
                    const startTime = performance.now();
                    $('#json-tree .json-item[data-expandable="true"]').removeClass('expanded');
                    const endTime = performance.now();
                    
                    statusMessage.text(`All nodes collapsed in ${(endTime - startTime).toFixed(2)}ms`);
                    setTimeout(() => {
                        statusMessage.text('');
                    }, 2000);
                });

                // Format JSON function
                function formatJson() {
                    try {
                        const startTime = performance.now();
                        const content = jsonInput.val().trim();
                        if (content) {
                            currentJson = parseJson(content);
                            
                            const indent = getIndentation();
                            const formatted = JSON.stringify(currentJson, null, indent);
                            jsonInput.val(formatted);
                            errorMessage.addClass('hidden');

                            // Set text to not wrap in formatted mode
                            document.getElementById('json-input').style.whiteSpace = 'pre';
                            
                            const endTime = performance.now();
                            statusMessage.text(`Formatted in ${(endTime - startTime).toFixed(2)}ms`);
                            updateCharCount();
                            updateLineNumbers();
                            
                            // Success animation for button
                            formatBtn.addClass('positive').delay(1000).queue(function(){
                                $(this).removeClass('positive').dequeue();
                            });
                            
                            // Always render tree view
                            renderTreeView();
                        }
                    } catch (e) {
                        showError(e.message);
                        currentJson = null; // Invalidate JSON on error
                        treeViewContainer.html(''); // Clear tree on error
                    }
                }
                
                // Minify JSON function
                function minifyJson() {
                    try {
                        const startTime = performance.now();
                        const content = jsonInput.val().trim();
                        
                        currentJson = parseJson(content);
                        
                        const minified = JSON.stringify(currentJson);
                        jsonInput.val(minified + '\n'); // Add line break at the end
                        errorMessage.addClass('hidden');

                        // Set text to wrap in minified mode
                        document.getElementById('json-input').style.whiteSpace = 'pre-wrap';
                        document.getElementById('json-input').style.wordWrap = 'break-word';

                        const endTime = performance.now();
                        statusMessage.text(`Minified in ${(endTime - startTime).toFixed(2)}ms`);
                        updateCharCount();
                        updateLineNumbers();
                        
                        // Success animation for button
                        minifyBtn.addClass('positive').delay(1000).queue(function(){
                            $(this).removeClass('positive').dequeue();
                        });
                        
                        renderTreeView(); // Update tree view
                    } catch (e) {
                        showError(e.message);
                        currentJson = null; // Invalidate JSON on error
                        treeViewContainer.html(''); // Clear tree on error
                    }
                }
                
                // Validate JSON function
                function validateJson() {
                    try {
                        const startTime = performance.now();
                        const content = jsonInput.val().trim();
                        
                        currentJson = parseJson(content);
                        
                        errorMessage.addClass('hidden');
                        
                        const endTime = performance.now();
                        statusMessage.text(`Valid JSON! Validated in ${(endTime - startTime).toFixed(2)}ms`);
                        
                        // Success animation for button
                        validateBtn.addClass('positive').delay(1000).queue(function(){
                            $(this).removeClass('positive').dequeue();
                        });
                        
                        renderTreeView(); // Update tree view
                    } catch (e) {
                        showError(e.message);
                        currentJson = null; // Invalidate JSON on error
                        treeViewContainer.html(''); // Clear tree on error
                    }
                }
                
                // Sort JSON function
                function sortJson() {
                    try {
                        const startTime = performance.now();
                        const content = jsonInput.val().trim();
                        
                        currentJson = parseJson(content);
                        
                        // Sort the JSON object
                        const sorted = sortObject(currentJson);
                        
                        // Update the textarea with sorted JSON
                        const indent = getIndentation();
                        jsonInput.val(JSON.stringify(sorted, null, indent));
                        errorMessage.addClass('hidden');

                        // Set text to not wrap in formatted mode
                        document.getElementById('json-input').style.whiteSpace = 'pre';

                        const endTime = performance.now();
                        statusMessage.text(`Sorted in ${(endTime - startTime).toFixed(2)}ms`);
                        updateCharCount();
                        updateLineNumbers();
                        
                        // Success animation for button
                        sortBtn.addClass('positive').delay(1000).queue(function(){
                            $(this).removeClass('positive').dequeue();
                        });
                        
                        renderTreeView(); // Update tree view
                    } catch (e) {
                        showError(e.message);
                        currentJson = null; // Invalidate JSON on error
                        treeViewContainer.html(''); // Clear tree on error
                    }
                }
                
                // Sort object keys recursively
                function sortObject(obj) {
                    // If not an object or null, return the same value
                    if (obj === null || typeof obj !== 'object') {
                        return obj;
                    }
                    
                    // Handle arrays - sort each element but keep array order
                    if (Array.isArray(obj)) {
                        return obj.map(item => sortObject(item));
                    }
                    
                    // Create a new object with sorted keys
                    const sorted = {};
                    const keys = Object.keys(obj).sort();
                    
                    // Add each key-value pair in sorted order
                    for (const key of keys) {
                        sorted[key] = sortObject(obj[key]);
                    }
                    
                    return sorted;
                }
                
                // Repair JSON function to fix common syntax errors
                function repairJson(jsonString) {
                    if (!jsonString) return jsonString;
                    
                    let repaired = jsonString;
                    
                    // 1. Replace Python/JavaScript specific values with JSON equivalents
                    repaired = repaired
                        .replace(/\bNone\b/g, 'null')     // Python None -> null
                        .replace(/\bTrue\b/g, 'true')     // Python True -> true
                        .replace(/\bFalse\b/g, 'false')   // Python False -> false
                        .replace(/\bundefined\b/g, 'null') // JavaScript undefined -> null
                        .replace(/\bNaN\b/g, 'null');     // JavaScript NaN -> null
                    
                    // 2. Fix trailing commas in arrays and objects
                    repaired = repaired
                        .replace(/,\s*([}\]])/g, '$1');   // Remove trailing commas
                    
                    // 3. Convert single quotes to double quotes for property names and string values
                    // This is more complex as we need to handle nested quotes and escaping
                    
                    // Step 1: First handle property names with single quotes
                    repaired = repaired.replace(/'([^']+)'\s*:/g, function(match, p1) {
                        // Escape any double quotes in the property name
                        return `"${p1.replace(/"/g, '\\"')}":`; 
                    });
                    
                    // Step 2: Handle string values with single quotes
                    // This regex finds single-quoted strings not followed by a colon (which would be a property name)
                    const singleQuoteRegex = /'((?:[^'\\]|\\.)*)'/g;
                    repaired = repaired.replace(singleQuoteRegex, function(match, p1) {
                        // Replace with double-quoted string, escaping any double quotes
                        return `"${p1.replace(/"/g, '\\"')}"`;
                    });
                    
                    // 4. Add quotes to unquoted property names
                    repaired = repaired.replace(/(\{|\,)\s*([a-zA-Z0-9_$]+)\s*:/g, '$1"$2":');
                    
                    return repaired;
                }
                
                // Get indentation setting
                function getIndentation() {
                    let value;
                    
                    // 直接使用Semantic UI的dropdown API
                    if (typeof $ !== 'undefined' && typeof $.fn.dropdown !== 'undefined') {
                        value = $('#indent-dropdown').dropdown('get value');
                    } else {
                        // 回退方案
                        const input = document.querySelector('#indent-dropdown input');
                        value = input ? input.value : '2';
                    }
                    
                    if (value === 'tab') {
                        return '\t';
                    }
                    return parseInt(value) || 2;
                }
                
                // Show error message
                function showError(message) {
                    errorMessage.text('Error: ' + message);
                    errorMessage.removeClass('hidden');
                    statusMessage.text('');
                    // Semantic UI negative button animation
                    validateBtn.addClass('negative').delay(1000).queue(function(){
                        $(this).removeClass('negative').dequeue();
                    });
                }
                
                // Copy to clipboard function
                function copyToClipboard(text) {
                    if (!navigator.clipboard) {
                        // Fallback for older browsers
                        const textarea = document.createElement('textarea');
                        textarea.value = text;
                        textarea.style.position = 'fixed'; // Prevent scrolling to bottom
                        document.body.appendChild(textarea);
                        textarea.focus();
                        textarea.select();
                        try {
                            document.execCommand('copy');
                        } catch (err) {
                            console.error('Fallback: Oops, unable to copy', err);
                        }
                        document.body.removeChild(textarea);
                        return;
                    }
                    navigator.clipboard.writeText(text).then(function() {
                        /* success */
                    }, function(err) {
                        console.error('Async: Could not copy text: ', err);
                    });
                }
                
                // Format on load
                formatJson();
                
                // 添加拖拽分隔条的功能
                initResizer();
                
                // 初始化拖拽分隔条功能
                function initResizer() {
                    const resizer = document.getElementById('resizer');
                    const textView = document.getElementById('text-view');
                    const treeContainer = document.querySelector('.tree-container');
                    
                    // 检测是否为移动设备
                    const isMobile = window.innerWidth <= 700;
                    
                    if (isMobile) {
                        // 移动设备下设置初始布局
                        textView.style.flex = '1';
                        treeContainer.style.flex = '1';
                        
                        // 移动设备下的分隔条逻辑
                        const mobileResize = function(e) {
                            const y = e.clientY || e.touches[0].clientY;
                            const containerHeight = document.querySelector('.view-container').offsetHeight;
                            const textViewHeight = Math.max(150, Math.min(y, containerHeight - 200));
                            const textViewPercent = (textViewHeight / containerHeight) * 100;
                            
                            textView.style.flex = `0 0 ${textViewPercent}%`;
                        };
                        
                        // 移动设备下的触摸和鼠标事件处理
                        resizer.addEventListener('touchstart', function(e) {
                            document.addEventListener('touchmove', mobileResize);
                            document.addEventListener('touchend', function() {
                                document.removeEventListener('touchmove', mobileResize);
                            }, { once: true });
                        });
                        
                        resizer.addEventListener('mousedown', function(e) {
                            document.addEventListener('mousemove', mobileResize);
                            document.addEventListener('mouseup', function() {
                                document.removeEventListener('mousemove', mobileResize);
                            }, { once: true });
                        });
                    } else {
                        // 桌面版分隔条拖拽逻辑
                        let x = 0;
                        let textViewWidth = 0;
                        
                        const mouseDownHandler = function(e) {
                            x = e.clientX;
                            
                            const textViewRect = textView.getBoundingClientRect();
                            textViewWidth = textViewRect.width;
                            
                            document.addEventListener('mousemove', mouseMoveHandler);
                            document.addEventListener('mouseup', mouseUpHandler);
                            
                            e.preventDefault();
                        };
                        
                        const mouseMoveHandler = function(e) {
                            const dx = e.clientX - x;
                            
                            const containerWidth = document.querySelector('.view-container').offsetWidth;
                            const newTextViewWidth = Math.max(100, Math.min(textViewWidth + dx, containerWidth - 150));
                            const newTextViewPercent = (newTextViewWidth / containerWidth) * 100;
                            
                            textView.style.flex = `0 0 ${newTextViewPercent}%`;
                        };
                        
                        const mouseUpHandler = function() {
                            document.removeEventListener('mousemove', mouseMoveHandler);
                            document.removeEventListener('mouseup', mouseUpHandler);
                        };
                        
                        // 添加事件监听
                        resizer.addEventListener('mousedown', mouseDownHandler);
                    }
                    
                    // 窗口大小变化时重新初始化
                    window.addEventListener('resize', function() {
                        const newIsMobile = window.innerWidth <= 700;
                        if (newIsMobile !== isMobile) {
                            // 移除所有事件监听器
                            resizer.replaceWith(resizer.cloneNode(true));
                            // 重新初始化
                            initResizer();
                        }
                    });
                }
            });
        })();
    </script>
</body>
</html> 