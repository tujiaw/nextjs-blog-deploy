<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON Formatter Tool</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css">
    <style>
        html, body {
            padding: 0;
            margin: 0;
            height: 100%;
            width: 100%;
            overflow: hidden;
            background-color: #f8f8f8;
            font-size: 14px; /* Base font size */
        }
        body {
            display: flex;
            flex-direction: column;
        }
        .container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
        }
        .ui.segment, .segment {
            border: 1px solid rgba(34,36,38,.15);
            border-radius: 0;
            box-shadow: none;
            background-color: white;
            padding: 1em;
            margin: 0;
        }
        .view-container {
            flex: 1;
            display: flex; /* Use flexbox for line numbers */
            overflow: hidden;
            position: relative; /* Needed for error message absolute positioning */
            background-color: white;
        }
        #line-numbers {
            font-family: monospace;
            padding: 10px 5px 10px 10px;
            background-color: #f7f7f7;
            color: #aaa;
            text-align: right;
            overflow: hidden;
            user-select: none;
            border-right: 1px solid #ddd;
            font-size: 0.9rem;
            line-height: 1.5; /* Match textarea line-height */
        }
        #json-input {
            font-family: monospace;
            resize: none;
            width: 100%;
            height: 100%;
            padding: 10px;
            box-sizing: border-box;
            flex: 1;
            overflow: auto;
            white-space: pre;
            border: none;
            border-radius: 0;
            outline: none;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        #json-tree {
            flex: 1;
            overflow: auto;
            padding: 10px;
            font-family: monospace;
            font-size: 0.9rem;
            line-height: 1.5;
            display: none; /* Hidden by default */
        }
        .error-message {
            color: #db2828;
            font-weight: bold;
            padding: 5px 10px;
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: rgba(255, 240, 240, 0.9);
            border-top: 1px solid #db2828;
            z-index: 10; 
        }
        .header-container {
            display: flex;
            align-items: center;
            padding: 5px 10px;
            background-color: #fff;
            border-bottom: 1px solid #ddd;
            flex-wrap: wrap; /* Allow wrapping */
        }
        .header {
            margin: 0;
            display: flex;
            align-items: center;
            font-size: 1.1rem;
            margin-right: 15px;
        }
        .view-switcher {
            margin-right: auto; /* Pushes buttons to the right */
        }
         .view-switcher .button {
            background-color: #eee;
            color: #555;
            padding: 0.4em 0.8em;
            font-size: 0.8rem;
            border-radius: 3px;
         }
         .view-switcher .button.active {
            background-color: #ddd;
            color: #333;
            font-weight: bold;
         }
        .buttons {
            display: flex;
            flex-wrap: nowrap; /* Prevent button wrapping within the group */
            gap: 5px;
            margin-left: 10px;
        }
        .button {
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-height: 1em;
            border: none;
            border-radius: 3px;
            padding: 0.4em 0.8em;
            font-weight: 700;
            transition: opacity 0.1s ease, background-color 0.1s ease, color 0.1s ease, box-shadow 0.1s ease;
            text-decoration: none;
            font-size: 0.8rem;
            white-space: nowrap; /* Prevent text wrapping inside button */
        }
        .primary.button {
            background-color: #2185d0;
            color: white;
        }
        .button:hover {
            background-color: #1678c2;
            color: white;
        }
        .view-switcher .button:hover {
            background-color: #ccc;
            color: #333;
        }
        .dropdown {
            position: relative;
            display: inline-block;
        }
        .dropdown .menu {
            position: absolute;
            top: 100%;
            right: 0; /* Align dropdown to the right */
            left: auto;
            z-index: 1000;
            display: none;
            min-width: 8rem;
            background-color: white;
            border: 1px solid rgba(34,36,38,.15);
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,.15);
        }
        .dropdown.active .menu {
            display: block;
        }
        .dropdown .item {
            padding: 0.4em 0.8em;
            cursor: pointer;
        }
        .dropdown .item:hover {
            background-color: rgba(0,0,0,.05);
        }
        .dropdown .text {
            margin-right: 5px;
        }
        .input-container {
            position: relative;
            flex: 1;
            display: flex; /* Changed to flex for main views */
            flex-direction: row; /* Default to row for text view + lines */
            overflow: hidden;
        }
        .hidden {
            display: none !important;
        }
        .status-bar {
            background-color: #f5f5f5;
            border-top: 1px solid #ddd;
            padding: 3px 10px;
            font-size: 0.8rem;
            color: #555;
            display: flex;
            justify-content: space-between;
        }
        .icon {
            display: inline-block;
            width: 1.18em;
            height: 1em;
            font-style: normal;
            text-decoration: inherit;
            text-align: center;
            speak: none;
        }
        /* Fallback icons using Unicode */
        .trash.icon:before { content: "üóëÔ∏è"; }
        .copy.icon:before { content: "üìã"; }
        .check.icon:before { content: "‚úì"; }
        .code.icon:before { content: "{ }"; }
        .dropdown.icon:before { content: "‚ñº"; }

        /* Tree view styles */
        .json-tree ul {
            list-style-type: none;
            padding-left: 20px;
            margin: 0;
        }
        .json-tree li {
            position: relative;
        }
        .json-tree .caret {
            cursor: pointer;
            user-select: none;
            position: absolute;
            left: -15px;
            top: 0;
            font-size: 0.8em;
        }
        .json-tree .caret::before {
            content: "‚ñ∂";
            display: inline-block;
            margin-right: 6px;
        }
        .json-tree .caret-down::before {
            transform: rotate(90deg);
        }
        .json-tree .nested {
            display: none;
        }
        .json-tree .active {
            display: block;
        }
        .json-tree .key {
            color: #a52a2a; /* brown */
        }
        .json-tree .string {
            color: #008000; /* green */
        }
        .json-tree .number {
            color: #0000ff; /* blue */
        }
        .json-tree .boolean {
            color: #ff00ff; /* magenta */
        }
        .json-tree .null {
            color: #808080; /* gray */
        }
        .json-tree .value {
            margin-left: 5px;
        }

        @media (max-width: 700px) { /* Adjusted breakpoint */
            .header-container {
                flex-direction: column;
                align-items: flex-start;
            }
            .view-switcher {
                margin-right: 0;
                margin-bottom: 5px;
            }
            .buttons {
                margin-left: 0;
                width: 100%;
                justify-content: space-between;
            }
            .button {
                padding: 0.3em 0.6em;
                font-size: 0.75rem;
            }
            .dropdown {
                 font-size: 0.75rem;
            }
            .dropdown .menu {
                min-width: 6rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-container">
            <h1 class="header">
                <span class="code icon"></span>
                <span style="margin-left: 5px;">JSON Formatter</span>
            </h1>

            <div class="view-switcher">
                <button class="button active" data-view="text">Text</button>
                <button class="button" data-view="tree">Tree</button>
            </div>
            
            <div class="buttons">
                <button class="primary button" id="format-btn">Format</button>
                <button class="button" id="minify-btn">Minify</button>
                <button class="button" id="validate-btn">Validate</button>
                <button class="button" id="copy-btn">Copy</button>
                <button class="button" id="clear-btn">Clear</button>
                
                <div class="dropdown" id="indent-dropdown">
                    <input type="hidden" name="indent" value="2">
                    <div class="text">2 Spaces</div>
                    <span class="dropdown icon"></span>
                    <div class="menu">
                        <div class="item" data-value="2">2 Spaces</div>
                        <div class="item" data-value="4">4 Spaces</div>
                        <div class="item" data-value="tab">Tab</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="view-container">
             <div id="line-numbers">1</div> <!-- Line numbers container -->
             <div class="input-container" id="text-view">
                 <textarea id="json-input" placeholder="Paste your JSON here..."></textarea>
             </div>
             <div id="json-tree" class="json-tree"></div> <!-- Tree view container -->
             <div class="error-message hidden" id="error-message"></div>
        </div>
        
        <div class="status-bar">
            <div id="status-message"></div>
            <div id="char-count">Characters: 0</div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.js"></script>
    <script>
        // Fallback for jQuery if CDN fails
        if (typeof jQuery === 'undefined') {
            // Simple DOM manipulation functions
            function $(selector) {
                if (typeof selector === 'string') {
                    const elements = document.querySelectorAll(selector);
                    return {
                        elements: elements,
                        val: function(value) {
                            if (value === undefined) {
                                return this.elements[0] ? this.elements[0].value : '';
                            } else {
                                this.elements.forEach(el => el.value = value);
                                return this;
                            }
                        },
                        text: function(value) {
                            if (value === undefined) {
                                return this.elements[0] ? this.elements[0].textContent : '';
                            } else {
                                this.elements.forEach(el => el.textContent = value);
                                return this;
                            }
                        },
                        html: function(value) {
                             if (value === undefined) {
                                 return this.elements[0] ? this.elements[0].innerHTML : '';
                             } else {
                                 this.elements.forEach(el => el.innerHTML = value);
                                 return this;
                             }
                         },
                        addClass: function(className) {
                            this.elements.forEach(el => el.classList.add(className));
                            return this;
                        },
                        removeClass: function(className) {
                            this.elements.forEach(el => el.classList.remove(className));
                            return this;
                        },
                         css: function(prop, value) {
                             if (value === undefined) {
                                 // Simple getter for single property
                                 return this.elements[0] ? window.getComputedStyle(this.elements[0])[prop] : undefined;
                             } else {
                                 this.elements.forEach(el => el.style[prop] = value);
                                 return this;
                             }
                         },
                        find: function(childSelector) {
                            const children = [];
                            this.elements.forEach(el => {
                                const found = el.querySelectorAll(childSelector);
                                found.forEach(child => children.push(child));
                            });
                             // Return a new chainable object
                             const newQuery = { elements: children };
                             Object.assign(newQuery, this);
                             newQuery.elements = children; // Ensure elements are the found children
                             return newQuery;
                        },
                        on: function(event, callback) {
                            this.elements.forEach(el => el.addEventListener(event, callback));
                            return this;
                        },
                        // Basic implementation for scroll event
                         scrollTop: function(value) {
                             if (value === undefined) {
                                 return this.elements[0] ? this.elements[0].scrollTop : 0;
                             } else {
                                 this.elements.forEach(el => el.scrollTop = value);
                                 return this;
                             }
                         }
                    };
                } else if (typeof selector === 'function') {
                     // Handle document ready
                     documentReady(selector);
                     return undefined; // Return undefined for ready function
                 } else if (selector.nodeType || selector === window || selector === document) {
                     // Handle direct nodes, window, document
                     const newQuery = { elements: [selector] };
                     // Copy methods from prototype, but be careful not to overwrite 'elements'
                     Object.assign(newQuery, $().constructor.prototype);
                     newQuery.elements = [selector];
                     return newQuery;
                 } else {
                    return { elements: [] }; // Return empty set for invalid selectors
                 }
            }

            $.fn = {}; // Keep for potential Semantic UI fallback check
            
            // Simple document ready function
            function documentReady(fn) {
                if (document.readyState !== 'loading') {
                    fn();
                } else {
                    document.addEventListener('DOMContentLoaded', fn);
                }
            }
        } 

        // Initialize dropdown functionality (Semantic UI or fallback)
        function initDropdown() {
            const dropdown = document.getElementById('indent-dropdown');
            if (!dropdown) return;

            const textEl = dropdown.querySelector('.text');
            const inputEl = dropdown.querySelector('input');
            const menuEl = dropdown.querySelector('.menu');

            dropdown.addEventListener('click', function(e) {
                this.classList.toggle('active');
                e.stopPropagation();
            });

            menuEl.addEventListener('click', function(e) {
                if (e.target.classList.contains('item')) {
                    const value = e.target.getAttribute('data-value');
                    inputEl.value = value;
                    textEl.textContent = e.target.textContent;
                    dropdown.classList.remove('active');
                }
            });

            document.addEventListener('click', function() {
                dropdown.classList.remove('active');
            });
        }

        // Function to create Tree View HTML
        function createTreeView(jsonObj, isRoot = true, depth = 0) {
            const MAX_DEPTH = 100;
            if (depth > MAX_DEPTH) {
                return '<ul class="json-branch"><li><span style="color: red;">[Max depth exceeded]</span></li></ul>';
            }

            // Âà§Êñ≠ÊòØÂê¶ÊòØÊï∞ÁªÑ„ÄÅÁ°ÆÂÆöÈÖçÂØπÊã¨Âè∑
            const isArray = Array.isArray(jsonObj);
            const bracketOpen = isArray ? '[' : '{';
            const bracketClose = isArray ? ']' : '}';

            // Â¶ÇÊûúÊòØÊ†πËäÇÁÇπÔºåÂ∞±Áî®Â§ñÂ±Ç <ul class="json-branch"> ÂåÖË£π
            let html = isRoot ? '<ul class="json-branch">' : '';

            // ÂÖàËæìÂá∫ÂºÄÂ§¥Ôºöcaret + Â∑¶Êã¨Âè∑
            // caret-down + active => ÈªòËÆ§Â±ïÂºÄ
            html += `<li><span class="caret caret-down"></span><span class="brace">${bracketOpen}</span>`;

            // Â≠êÈ°πÊîæÂú®ÂµåÂ•óÁöÑ <ul class="nested active"> Èáå
            html += `<ul class="nested active">`;

            try {
                if (isArray) {
                    // Â§ÑÁêÜÊï∞ÁªÑ
                    if (jsonObj.length === 0) {
                        // Á©∫Êï∞ÁªÑ
                        html += `<li><em>/* empty array */</em></li>`;
                    } else {
                        jsonObj.forEach((value, index) => {
                            html += '<li>';
                            // ÊòæÁ§∫Á¥¢Âºï
                            html += `<span class="key array-index">${index}:</span> `;
                            if (value && typeof value === 'object') {
                                // ÈÄíÂΩíË∞ÉÁî®
                                html += createTreeView(value, false, depth + 1);
                            } else {
                                // Âü∫Êú¨Á±ªÂûã
                                const valStr = JSON.stringify(value);
                                const valType = (value === null) ? 'null' : typeof value;
                                html += `<span class="value ${valType}">${valStr}</span>`;
                            }
                            html += '</li>';
                        });
                    }
                } else {
                    // Â§ÑÁêÜÂØπË±°
                    const keys = Object.keys(jsonObj);
                    if (keys.length === 0) {
                        // Á©∫ÂØπË±°
                        html += `<li><em>/* empty object */</em></li>`;
                    } else {
                        keys.forEach(key => {
                            html += '<li>';
                            // ÊòæÁ§∫ÈîÆÂêç
                            html += `<span class="key">"${key}":</span> `;
                            const value = jsonObj[key];
                            if (value && typeof value === 'object') {
                                // ÈÄíÂΩíË∞ÉÁî®
                                html += createTreeView(value, false, depth + 1);
                            } else {
                                // Âü∫Êú¨Á±ªÂûã
                                const valStr = JSON.stringify(value);
                                const valType = (value === null) ? 'null' : typeof value;
                                html += `<span class="value ${valType}">${valStr}</span>`;
                            }
                            html += '</li>';
                        });
                    }
                }
            } catch (err) {
                console.error("Error rendering tree view:", err);
                html += `<li style="color:red;">[Error rendering this node]</li>`;
            }

            // ÂÖ≥ÊéâÂ≠ê <ul>ÔºåÂÜçËæìÂá∫Âè≥Êã¨Âè∑
            html += `</ul><span class="brace">${bracketClose}</span></li>`;

            // Â¶ÇÊûúÊòØÊ†πËäÇÁÇπÔºåÊî∂Â∞æ </ul>
            if (isRoot) {
                html += '</ul>';
            }

            return html;
        }

        // Function to add interactivity to the Tree View
        function initTreeViewInteractivity(treeContainer) {
            treeContainer.addEventListener("click", function (e) {
                if (e.target.classList.contains("caret")) {
                    e.target.parentElement.querySelector(".nested").classList.toggle("active");
                    e.target.classList.toggle("caret-down");
                }
            });
        }

        // Function to update line numbers
        function updateLineNumbers() {
            const linesDiv = document.getElementById('line-numbers');
            const textarea = document.getElementById('json-input');
            if (!linesDiv || !textarea) return;

            try {
                const lines = textarea.value.split('\n');
                const lineCount = lines.length;
                let linesHtml = '';
                for (let i = 1; i <= lineCount; i++) {
                    linesHtml += i + '<br>';
                }
                linesDiv.innerHTML = linesHtml;

                // Synchronize scroll
                linesDiv.scrollTop = textarea.scrollTop;
            } catch (e) {
                console.error("Error updating line numbers:", e);
                linesDiv.innerHTML = '1'; // Fallback
            }
        }
        
        // Document ready function
        (function() {
            // Try to use jQuery if available, otherwise use our fallback
            const ready = (typeof jQuery !== 'undefined') ? jQuery : documentReady;
            
            ready(function() {
                // Initialize dropdowns if Semantic UI is not available
                if (typeof $.fn.dropdown === 'undefined') {
                    initDropdown();
                } else {
                    $('.dropdown').dropdown(); // Use basic selector
                }
                
                // DOM Elements
                const jsonInput = $('#json-input');
                const lineNumbers = $('#line-numbers');
                const treeViewContainer = $('#json-tree');
                const textViewContainer = $('#text-view');
                const formatBtn = $('#format-btn');
                const minifyBtn = $('#minify-btn');
                const validateBtn = $('#validate-btn');
                const errorMessage = $('#error-message');
                const indentDropdown = $('#indent-dropdown');
                const copyBtn = $('#copy-btn');
                const clearBtn = $('#clear-btn');
                const statusMessage = $('#status-message');
                const charCount = $('#char-count');
                const viewSwitcherBtns = $(".view-switcher .button");
                
                let currentView = 'text'; // Default view
                let currentJson = null; // Store parsed JSON

                // Sample JSON for initial demo
                const sampleJson = {
                    "name": "JSON Formatter Tool",
                    "description": "A tool to format, validate and beautify JSON data",
                    "features": ["Format", "Minify", "Validate"],
                    "settings": {
                        "indentation": 2,
                        "theme": "light"
                    },
                    "isAwesome": true,
                    "version": 1.0,
                    "nested": {
                        "level1": [1, 2, {"deep": true}]
                    }
                };
                
                // Set sample JSON
                jsonInput.val(JSON.stringify(sampleJson, null, 2));
                try { currentJson = JSON.parse(jsonInput.val()); } catch(e) { currentJson = null; }
                updateCharCount();
                updateLineNumbers();
                renderTreeView(); // Initial render
                
                // Update character count
                function updateCharCount() {
                    const count = jsonInput.val().length;
                    charCount.text(`Characters: ${count.toLocaleString()}`);
                }

                // Render Tree View
                function renderTreeView() {
                    if (currentJson && currentView === 'tree') {
                        const startTime = performance.now();
                        try {
                            const treeHtml = createTreeView(currentJson);
                            treeViewContainer.html(treeHtml);

                            // ÂÖºÂÆπÂ§ÑÁêÜÔºöÂêåÊó∂Ê£ÄÊü• fallback $() Âíå jQuery
                            // Ëã•Â≠òÂú® fallback .elementsÔºåÂàôÁî® elements[0]
                            // Ëã•Â≠òÂú® jQuery ÂØπË±°ÔºåÂàôÁî® [0]
                            const containerElem = (treeViewContainer.elements && treeViewContainer.elements[0]) 
                                                  || treeViewContainer[0];
                            if (containerElem) {
                                initTreeViewInteractivity(containerElem);
                            }

                            const endTime = performance.now();
                            statusMessage.text(`Tree rendered in ${(endTime - startTime).toFixed(2)}ms`);
                        } catch (e) {
                            console.error("Error rendering tree:", e);
                            treeViewContainer.html('<p style="color: red;">Error rendering tree view.</p>');
                            statusMessage.text(`Error rendering tree.`);
                        }
                    } else {
                        treeViewContainer.html(''); // Clear if no valid JSON or not in tree view
                    }
                }
                
                // Input change event
                jsonInput.on('input', function() {
                    errorMessage.addClass('hidden'); // Hide error on new input
                    statusMessage.text('');
                    try { currentJson = JSON.parse(jsonInput.val()); } catch(e) { currentJson = null; }
                    updateCharCount();
                    updateLineNumbers();
                     // Optionally update tree view live? Might be slow. Let's update on format.
                });

                // Sync scroll for line numbers
                 jsonInput.on('scroll', function() {
                     lineNumbers.scrollTop(jsonInput.scrollTop());
                 });
                
                // Format JSON
                formatBtn.on('click', function() {
                    formatJson();
                });
                
                // Minify JSON
                minifyBtn.on('click', function() {
                    minifyJson();
                });
                
                // Validate JSON
                validateBtn.on('click', function() {
                    validateJson();
                });
                
                // Clear input
                clearBtn.on('click', function() {
                    jsonInput.val('');
                    errorMessage.addClass('hidden');
                    statusMessage.text('');
                    currentJson = null;
                    updateCharCount();
                    updateLineNumbers();
                    renderTreeView();
                });
                
                // Copy output
                copyBtn.on('click', function() {
                    // Copy raw text regardless of view
                    const output = jsonInput.val();
                    copyToClipboard(output);
                    
                    statusMessage.text('Copied to clipboard!');
                    setTimeout(() => {
                        statusMessage.text('');
                    }, 2000);
                });

                // View Switcher Logic
                 viewSwitcherBtns.on('click', function(e) {
                     const targetView = e.target.getAttribute('data-view');
                     if (targetView === currentView) return;

                     currentView = targetView;

                     // Update button styles
                     viewSwitcherBtns.removeClass('active');
                     $(e.target).addClass('active');

                     // Toggle view visibility
                     if (currentView === 'text') {
                         textViewContainer.css('display', 'flex'); // Use flex for line numbers
                         treeViewContainer.css('display', 'none');
                         updateLineNumbers(); // Ensure line numbers are up-to-date
                     } else { // Tree view
                         textViewContainer.css('display', 'none');
                         treeViewContainer.css('display', 'block');
                         renderTreeView(); // Render tree if switching to it
                     }
                      errorMessage.addClass('hidden'); // Hide error on view switch
                      statusMessage.text('');
                 });
                
                // Format JSON function
                function formatJson() {
                    try {
                        const startTime = performance.now();
                        currentJson = JSON.parse(jsonInput.val()); // Update currentJson
                        const indent = getIndentation();
                        const formatted = JSON.stringify(currentJson, null, indent);
                        jsonInput.val(formatted);
                        errorMessage.addClass('hidden');
                        
                        const endTime = performance.now();
                        statusMessage.text(`Formatted in ${(endTime - startTime).toFixed(2)}ms`);
                        updateCharCount();
                        updateLineNumbers();
                        renderTreeView(); // Update tree view as well
                    } catch (e) {
                        showError(e.message);
                        currentJson = null; // Invalidate JSON on error
                        renderTreeView(); // Clear tree on error
                    }
                }
                
                // Minify JSON function
                function minifyJson() {
                    try {
                        const startTime = performance.now();
                        currentJson = JSON.parse(jsonInput.val()); // Update currentJson
                        const minified = JSON.stringify(currentJson);
                        jsonInput.val(minified);
                        errorMessage.addClass('hidden');
                        
                        // Switch to text view if not already there, as tree view isn't useful for minified
                        if (currentView !== 'text') {
                             viewSwitcherBtns.elements.forEach(btn => {
                                 if (btn.getAttribute('data-view') === 'text') {
                                     btn.click(); // Simulate click
                                 }
                             });
                         }

                        const endTime = performance.now();
                        statusMessage.text(`Minified in ${(endTime - startTime).toFixed(2)}ms`);
                        updateCharCount();
                        updateLineNumbers();
                        renderTreeView(); // Clear tree view content
                    } catch (e) {
                        showError(e.message);
                        currentJson = null; // Invalidate JSON on error
                        renderTreeView(); // Clear tree on error
                    }
                }
                
                // Validate JSON function
                function validateJson() {
                    try {
                        const startTime = performance.now();
                        currentJson = JSON.parse(jsonInput.val()); // Update currentJson
                        errorMessage.addClass('hidden');
                        
                        const endTime = performance.now();
                        statusMessage.text(`Valid JSON! Validated in ${(endTime - startTime).toFixed(2)}ms`);
                        // Re-render tree if in tree view to ensure it reflects validated JSON
                        if (currentView === 'tree') {
                           renderTreeView(); 
                        }
                    } catch (e) {
                        showError(e.message);
                        currentJson = null; // Invalidate JSON on error
                         renderTreeView(); // Clear tree on error
                    }
                }
                
                // Get indentation setting
                function getIndentation() {
                    let value;
                    // Check if Semantic UI dropdown is initialized
                    const dropdownElement = document.getElementById('indent-dropdown');
                    if (typeof $ !== 'undefined' && typeof $.fn.dropdown !== 'undefined' && dropdownElement && dropdownElement.classList.contains('ui')) {
                        value = $(indentDropdown).dropdown('get value');
                    } else {
                        // Fallback
                        const input = document.querySelector('#indent-dropdown input');
                        value = input ? input.value : '2';
                    }
                    
                    if (value === 'tab') {
                        return '\t';
                    }
                    return parseInt(value) || 2;
                }
                
                // Show error message
                function showError(message) {
                    errorMessage.text('Error: ' + message);
                    errorMessage.removeClass('hidden');
                    statusMessage.text('');
                }
                
                // Copy to clipboard function
                function copyToClipboard(text) {
                    if (!navigator.clipboard) {
                        // Fallback for older browsers
                        const textarea = document.createElement('textarea');
                        textarea.value = text;
                        textarea.style.position = 'fixed'; // Prevent scrolling to bottom
                        document.body.appendChild(textarea);
                        textarea.focus();
                        textarea.select();
                        try {
                            document.execCommand('copy');
                        } catch (err) {
                            console.error('Fallback: Oops, unable to copy', err);
                        }
                        document.body.removeChild(textarea);
                        return;
                    }
                    navigator.clipboard.writeText(text).then(function() {
                        /* success */
                    }, function(err) {
                        console.error('Async: Could not copy text: ', err);
                    });
                }
                
                // Format on load
                formatJson();
            });
        })();
    </script>
</body>
</html> 