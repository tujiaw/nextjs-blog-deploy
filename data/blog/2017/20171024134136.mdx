---
title: '精灵程序(daemon)'
date: '2017-10-24'
tags: ['Linux']
draft: false
summary: 精灵程序（daemon）生存期长，在系统引导装入时起动，关闭时终止。编程规则包括 fork、setsid、更改工作目录等，示例代码展示了初始化过程，查看其 ID 用 ps -ef ，退出用 kill ，源自《UNIX 环境高级编程》。 
---

精灵进程（daemon）是生存期长的一种进程。它们常常在系统引导装入时起动，在系统

关闭时终止。因为它们没有控制终端，所以说它们是在后台运行的。UNIX系统有很多精灵进程，它们执行日常事物活动。

编程规则：

(1) 首先做的是调用fork，然后使父进程exit。这样做实现了下面几点：第一，如果该精灵进程是由一条简单shell命令起动的，那么使父进程终止使得shell认为这条命令已经执行完成。

第二，子进程继承了父进程的进程组ID，但具有一个新的进程ID，这就保证了子进程不是一个进程组的首进程。这对于下面就要做的setsid调用是必要的前提条件。

(2) 调用setsid以创建一个新对话期。于是下面程序中列举的三个操作，使调用进程：

（a）成为新对话期的首进程，  
（b）成为一个新进程组的首进程，  
（c）没有控制终端。  

(3) 将当前工作目录更改为根目录。从父进程继承过来的当前工作目录可能在一个装配的文件系统中。因为精灵进程通常在系统再引导之前是一直存在的，所以如果精灵进程的当前工作目录在一个装配文件系统中，那么该文件系统就不能被拆卸。

    
另外，某些精灵进程可能会把当前工作目录更改到某个指定位置，在此位置做它们的工作。

例如，行式打印机假脱机精灵进程常常将其工作目录更改到它们的spool目录上。

(4) 将文件方式创建屏蔽字设置为0。由继承得来的文件方式创建屏蔽字可能会拒绝设置某些许可权。例如，若精灵进程要创建一个组可读、写的文件，而继承的文件方式创建屏蔽字，屏蔽了这两种许可权，则所要求的组可读、写就不能起作用。

(5) 关闭不再需要的文件描述符。这样使精灵进程就不再持有从其父进程继承来的某些文件描述符（父进程可能是shell进程，或某个其他进程）。但是，究竟关闭哪些描述符则与具体的精灵进程有关，所以在下面的例子中不包含此步骤。
```

int daemon_init(void)
{
    pid_t pid;

    if ((pid = fork()) < 0)
    {
        return -1;
    }
    else if (pid != 0)
    {
        exit(0);
    }

    setsid();
    chdir("/");
    umask(0);

    return 0;
}
```

查看精灵程序ID：ps -ef | grep name

退出精灵程序：kill 进程ID

from:《UNIX环境高级编程》